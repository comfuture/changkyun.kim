<!DOCTYPE html><html  lang="ko" data-capo=""><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>몽고디비 페이징과 룩업 성능</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
<style>*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com*/*,:after,:before{border:0 solid #e5e7eb;box-sizing:border-box}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-tap-highlight-color:transparent}body{line-height:inherit;margin:0}hr{border-top-width:1px;color:inherit;height:0}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-size:1em;font-variation-settings:normal}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-collapse:collapse;border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{color:inherit;font-family:inherit;font-feature-settings:inherit;font-size:100%;font-variation-settings:inherit;font-weight:inherit;letter-spacing:inherit;line-height:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.prose{color:var(--tw-prose-body);max-width:65ch}.prose :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-lead);font-size:1.25em;line-height:1.6;margin-bottom:1.2em;margin-top:1.2em}.prose :where(a):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-links);font-weight:500;text-decoration:underline}.prose :where(strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}.prose :where(a strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol[type=A]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=A s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=I]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type=I s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type="1"]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal}.prose :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:disc;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-counters);font-weight:400}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}.prose :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;margin-top:1.25em}.prose :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-bottom:3em;margin-top:3em}.prose :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){border-inline-start-color:var(--tw-prose-quote-borders);border-inline-start-width:.25rem;color:var(--tw-prose-quotes);font-style:italic;font-weight:500;margin-bottom:1.6em;margin-top:1.6em;padding-inline-start:1em;quotes:"“""”""‘""’"}.prose :where(blockquote p:first-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:open-quote}.prose :where(blockquote p:last-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:close-quote}.prose :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:2.25em;font-weight:800;line-height:1.1111111;margin-bottom:.8888889em;margin-top:0}.prose :where(h1 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:900}.prose :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.5em;font-weight:700;line-height:1.3333333;margin-bottom:1em;margin-top:2em}.prose :where(h2 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:800}.prose :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.25em;font-weight:600;line-height:1.6;margin-bottom:.6em;margin-top:1.6em}.prose :where(h3 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;line-height:1.5;margin-bottom:.5em;margin-top:1.5em}.prose :where(h4 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){display:block;margin-bottom:2em;margin-top:2em}.prose :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;box-shadow:0 0 0 1px rgb(var(--tw-prose-kbd-shadows)/10%),0 3px rgb(var(--tw-prose-kbd-shadows)/10%);color:var(--tw-prose-kbd);font-family:inherit;font-size:.875em;font-weight:500;padding-inline-end:.375em;padding-bottom:.1875em;padding-top:.1875em;padding-inline-start:.375em}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-code);font-size:.875em;font-weight:600}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:"`"}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:"`"}.prose :where(a code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h1 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.875em}.prose :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.9em}.prose :where(h4 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:var(--tw-prose-pre-bg);border-radius:.375rem;color:var(--tw-prose-pre-code);font-size:.875em;font-weight:400;line-height:1.7142857;margin-bottom:1.7142857em;margin-top:1.7142857em;overflow-x:auto;padding-inline-end:1.1428571em;padding-bottom:.8571429em;padding-top:.8571429em;padding-inline-start:1.1428571em}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:transparent;border-radius:0;border-width:0;color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;line-height:inherit;padding:0}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:none}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:none}.prose :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em;line-height:1.7142857;margin-bottom:2em;margin-top:2em;table-layout:auto;width:100%}.prose :where(thead):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-th-borders);border-bottom-width:1px}.prose :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-inline-start:.5714286em;vertical-align:bottom}.prose :where(tbody tr):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-td-borders);border-bottom-width:1px}.prose :where(tbody tr:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:0}.prose :where(tbody td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:baseline}.prose :where(tfoot):not(:where([class~=not-prose],[class~=not-prose] *)){border-top-color:var(--tw-prose-th-borders);border-top-width:1px}.prose :where(tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:top}.prose :where(th,td):not(:where([class~=not-prose],[class~=not-prose] *)){text-align:start}.prose :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-captions);font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.prose{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-kbd:#111827;--tw-prose-kbd-shadows:17 24 39;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-kbd:#fff;--tw-prose-invert-kbd-shadows:255 255 255;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:rgba(0,0,0,.5);--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}.prose :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.5em;margin-top:.5em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(.prose>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(.prose>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(.prose>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.5em;padding-inline-start:1.625em}.prose :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-top:.5714286em;padding-inline-start:.5714286em}.prose :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(.prose>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(.prose>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}.sr-only{height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px;clip:rect(0,0,0,0);border-width:0;white-space:nowrap}.absolute{position:absolute}.sticky{position:sticky}.top-\[-1px\]{top:-1px}.z-0{z-index:0}.-m-16{margin:-4rem}.mx-auto{margin-left:auto;margin-right:auto}.my-2{margin-bottom:.5rem;margin-top:.5rem}.my-3{margin-bottom:.75rem;margin-top:.75rem}.my-4{margin-top:1rem}.mb-4,.my-4{margin-bottom:1rem}.mt-6{margin-top:1.5rem}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.hidden{display:none}.h-32{height:8rem}.h-6{height:1.5rem}.h-\[300px\]{height:300px}.h-\[56px\]{height:56px}.max-h-96{max-height:24rem}.w-32{width:8rem}.w-6{width:1.5rem}.w-full{width:100%}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-center{justify-content:center}.justify-items-stretch{justify-items:stretch}.gap-2{gap:.5rem}.break-all{word-break:break-all}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-none{border-style:none}.border-blue-300{--tw-border-opacity:1;border-color:rgb(147 197 253/var(--tw-border-opacity,1))}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.bg-gray-600{--tw-bg-opacity:1;background-color:rgb(75 85 99/var(--tw-bg-opacity,1))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.bg-white\/40{background-color:#fff6}.bg-white\/60{background-color:#fff9}.fill-current{fill:currentColor}.object-cover{-o-object-fit:cover;object-fit:cover}.p-4{padding:1rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-bottom:.25rem;padding-top:.25rem}.py-10{padding-bottom:2.5rem;padding-top:2.5rem}.py-2{padding-bottom:.5rem;padding-top:.5rem}.py-4{padding-bottom:1rem;padding-top:1rem}.pt-24{padding-top:6rem}.text-center{text-align:center}.align-middle{vertical-align:middle}.text-2xl{font-size:1.5rem;line-height:2rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.font-bold{font-weight:700}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.leading-relaxed{line-height:1.625}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.shadow{--tw-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color)}.shadow,.shadow-lg{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 8px 10px -6px rgba(0,0,0,.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.transition{transition-duration:.15s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.dark\:prose-invert:is(.dark *){--tw-prose-body:var(--tw-prose-invert-body);--tw-prose-headings:var(--tw-prose-invert-headings);--tw-prose-lead:var(--tw-prose-invert-lead);--tw-prose-links:var(--tw-prose-invert-links);--tw-prose-bold:var(--tw-prose-invert-bold);--tw-prose-counters:var(--tw-prose-invert-counters);--tw-prose-bullets:var(--tw-prose-invert-bullets);--tw-prose-hr:var(--tw-prose-invert-hr);--tw-prose-quotes:var(--tw-prose-invert-quotes);--tw-prose-quote-borders:var(--tw-prose-invert-quote-borders);--tw-prose-captions:var(--tw-prose-invert-captions);--tw-prose-kbd:var(--tw-prose-invert-kbd);--tw-prose-kbd-shadows:var(--tw-prose-invert-kbd-shadows);--tw-prose-code:var(--tw-prose-invert-code);--tw-prose-pre-code:var(--tw-prose-invert-pre-code);--tw-prose-pre-bg:var(--tw-prose-invert-pre-bg);--tw-prose-th-borders:var(--tw-prose-invert-th-borders);--tw-prose-td-borders:var(--tw-prose-invert-td-borders)}@media (min-width:768px){.md\:prose-lg{font-size:1.125rem;line-height:1.7777778}.md\:prose-lg :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}.md\:prose-lg :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.2222222em;line-height:1.4545455;margin-bottom:1.0909091em;margin-top:1.0909091em}.md\:prose-lg :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.6666667em;margin-top:1.6666667em;padding-inline-start:1em}.md\:prose-lg :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:2.6666667em;line-height:1;margin-bottom:.8333333em;margin-top:0}.md\:prose-lg :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.6666667em;line-height:1.3333333;margin-bottom:1.0666667em;margin-top:1.8666667em}.md\:prose-lg :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.3333333em;line-height:1.5;margin-bottom:.6666667em;margin-top:1.6666667em}.md\:prose-lg :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){line-height:1.5555556;margin-bottom:.4444444em;margin-top:1.7777778em}.md\:prose-lg :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.md\:prose-lg :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.md\:prose-lg :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.md\:prose-lg :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.md\:prose-lg :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;font-size:.8888889em;padding-inline-end:.4444444em;padding-bottom:.2222222em;padding-top:.2222222em;padding-inline-start:.4444444em}.md\:prose-lg :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em}.md\:prose-lg :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8666667em}.md\:prose-lg :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em}.md\:prose-lg :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.375rem;font-size:.8888889em;line-height:1.75;margin-bottom:2em;margin-top:2em;padding-inline-end:1.5em;padding-bottom:1em;padding-top:1em;padding-inline-start:1.5em}.md\:prose-lg :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}.md\:prose-lg :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}.md\:prose-lg :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.6666667em;margin-top:.6666667em}.md\:prose-lg :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}.md\:prose-lg :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}.md\:prose-lg :where(.md\:prose-lg>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.md\:prose-lg :where(.md\:prose-lg>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.md\:prose-lg :where(.md\:prose-lg>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}.md\:prose-lg :where(.md\:prose-lg>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.md\:prose-lg :where(.md\:prose-lg>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}.md\:prose-lg :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}.md\:prose-lg :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}.md\:prose-lg :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}.md\:prose-lg :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.6666667em;padding-inline-start:1.5555556em}.md\:prose-lg :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:3.1111111em;margin-top:3.1111111em}.md\:prose-lg :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.md\:prose-lg :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.md\:prose-lg :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.md\:prose-lg :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.md\:prose-lg :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5}.md\:prose-lg :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-inline-start:.75em}.md\:prose-lg :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.md\:prose-lg :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.md\:prose-lg :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-top:.75em;padding-inline-start:.75em}.md\:prose-lg :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.md\:prose-lg :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.md\:prose-lg :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}.md\:prose-lg :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.md\:prose-lg :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5;margin-top:1em}.md\:prose-lg :where(.md\:prose-lg>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.md\:prose-lg :where(.md\:prose-lg>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}}.dark\:border-gray-600:is(.dark *){--tw-border-opacity:1;border-color:rgb(75 85 99/var(--tw-border-opacity,1))}.dark\:bg-gray-600:is(.dark *){--tw-bg-opacity:1;background-color:rgb(75 85 99/var(--tw-bg-opacity,1))}.dark\:bg-gray-600\/40:is(.dark *){background-color:#4b556366}.dark\:bg-gray-800:is(.dark *){--tw-bg-opacity:1;background-color:rgb(31 41 55/var(--tw-bg-opacity,1))}.dark\:text-gray-300:is(.dark *){--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}@media (min-width:768px){.md\:relative{position:relative}.md\:mx-auto{margin-left:auto;margin-right:auto}.md\:-mt-16{margin-top:-4rem}.md\:mt-0{margin-top:0}.md\:flex{display:flex}.md\:hidden{display:none}.md\:h-48{height:12rem}.md\:max-h-\[400px\]{max-height:400px}.md\:w-10\/12{width:83.333333%}.md\:w-48{width:12rem}.md\:flex-row{flex-direction:row}.md\:rounded-lg{border-radius:.5rem}.md\:border-0{border-width:0}.md\:bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.md\:bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.md\:px-0{padding-left:0;padding-right:0}.md\:pt-16{padding-top:4rem}.md\:opacity-100{opacity:1}.md\:shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.md\:shadow-lg,.md\:shadow-none{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.md\:shadow-none{--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000}.md\:dark\:bg-gray-800:is(.dark *){--tw-bg-opacity:1;background-color:rgb(31 41 55/var(--tw-bg-opacity,1))}}@media (min-width:1280px){.xl\:w-8\/12{width:66.666667%}}</style>
<style>.material-symbols-outlined{font-variation-settings:"FILL" 1,"wght" 400,"GRAD" 0,"opsz" 48;vertical-align:middle}.page-enter-active,.page-leave-active{transition:opacity .35s}.page-enter-from,.page-leave-to{opacity:0}body{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}body:is(.dark *){--tw-bg-opacity:1;background-color:rgb(31 41 55/var(--tw-bg-opacity,1));--tw-text-opacity:1;color:rgb(229 231 235/var(--tw-text-opacity,1))}.site{display:flex;flex-direction:column;justify-items:stretch;min-height:100vh}.site>header{background-color:#fff9;height:56px;padding:1rem;position:sticky;top:-1px;z-index:50;--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow);--tw-backdrop-blur:blur(8px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.site>header:is(.dark *){background-color:#4b556366}.site>header .container{display:flex;justify-content:space-between;margin-left:auto;margin-right:auto}.site>header .container h1{font-weight:600;text-transform:uppercase}.site>header .container nav{align-items:flex-end;display:flex;flex-direction:column;gap:.5rem}.site>header .container nav menu{border-radius:.25rem;border-width:1px;margin-top:1.5rem;padding:1rem 2rem;position:absolute;--tw-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow);display:none}@media (min-width:768px){.site>header .container nav menu{border-width:0;margin-top:0;padding:0;position:relative;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}}.site>header .container nav menu{flex-direction:column;gap:.5rem}@media (min-width:768px){.site>header .container nav menu{display:flex;flex-direction:row;gap:1rem;opacity:1}}.site>header .container nav menu{font-size:.875rem;font-weight:600;line-height:1.25rem;text-transform:uppercase;--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.site>header .container nav menu:is(.dark *){--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.site>header .container nav button.active.hamburger+menu{display:flex;--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1));transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}.site>main{flex-grow:1}.site>footer{border-top-width:1px;--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1));padding:1rem}.site>footer:is(.dark *){--tw-border-opacity:1;border-color:rgb(75 85 99/var(--tw-border-opacity,1))}.site>footer .container{margin-left:auto;margin-right:auto}</style>
<style>button.hamburger{display:inline-block}@media (min-width:768px){button.hamburger{display:none}}</style>
<style>article.container{margin-left:auto;margin-right:auto;max-width:42rem}article.container img.cover{width:100%}article.container>header h1{font-size:1.25rem;font-weight:700;line-height:1.75rem;margin-bottom:.5rem;margin-top:.5rem}article.container .body{color:var(--tw-prose-body);max-width:65ch}article.container .body :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}article.container .body :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-lead);font-size:1.25em;line-height:1.6;margin-bottom:1.2em;margin-top:1.2em}article.container .body :where(a):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-links);font-weight:500;text-decoration:underline}article.container .body :where(strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}article.container .body :where(a strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(blockquote strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(thead th strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}article.container .body :where(ol[type=A]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}article.container .body :where(ol[type=a]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}article.container .body :where(ol[type=A s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}article.container .body :where(ol[type=a s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}article.container .body :where(ol[type=I]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}article.container .body :where(ol[type=i]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}article.container .body :where(ol[type=I s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}article.container .body :where(ol[type=i s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}article.container .body :where(ol[type="1"]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal}article.container .body :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:disc;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}article.container .body :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-counters);font-weight:400}article.container .body :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}article.container .body :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;margin-top:1.25em}article.container .body :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-bottom:3em;margin-top:3em}article.container .body :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){border-inline-start-color:var(--tw-prose-quote-borders);border-inline-start-width:.25rem;color:var(--tw-prose-quotes);font-style:italic;font-weight:500;margin-bottom:1.6em;margin-top:1.6em;padding-inline-start:1em;quotes:"“""”""‘""’"}article.container .body :where(blockquote p:first-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:open-quote}article.container .body :where(blockquote p:last-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:close-quote}article.container .body :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:2.25em;font-weight:800;line-height:1.1111111;margin-bottom:.8888889em;margin-top:0}article.container .body :where(h1 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:900}article.container .body :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.5em;font-weight:700;line-height:1.3333333;margin-bottom:1em;margin-top:2em}article.container .body :where(h2 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:800}article.container .body :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.25em;font-weight:600;line-height:1.6;margin-bottom:.6em;margin-top:1.6em}article.container .body :where(h3 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}article.container .body :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;line-height:1.5;margin-bottom:.5em;margin-top:1.5em}article.container .body :where(h4 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}article.container .body :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}article.container .body :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){display:block;margin-bottom:2em;margin-top:2em}article.container .body :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}article.container .body :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;box-shadow:0 0 0 1px rgb(var(--tw-prose-kbd-shadows)/10%),0 3px rgb(var(--tw-prose-kbd-shadows)/10%);color:var(--tw-prose-kbd);font-family:inherit;font-size:.875em;font-weight:500;padding-inline-end:.375em;padding-bottom:.1875em;padding-top:.1875em;padding-inline-start:.375em}article.container .body :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-code);font-size:.875em;font-weight:600}article.container .body :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:"`"}article.container .body :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:"`"}article.container .body :where(a code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(h1 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.875em}article.container .body :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.9em}article.container .body :where(h4 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(blockquote code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(thead th code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}article.container .body :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:var(--tw-prose-pre-bg);border-radius:.375rem;color:var(--tw-prose-pre-code);font-size:.875em;font-weight:400;line-height:1.7142857;margin-bottom:1.7142857em;margin-top:1.7142857em;overflow-x:auto;padding-inline-end:1.1428571em;padding-bottom:.8571429em;padding-top:.8571429em;padding-inline-start:1.1428571em}article.container .body :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:transparent;border-radius:0;border-width:0;color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;line-height:inherit;padding:0}article.container .body :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:none}article.container .body :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:none}article.container .body :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em;line-height:1.7142857;margin-bottom:2em;margin-top:2em;table-layout:auto;width:100%}article.container .body :where(thead):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-th-borders);border-bottom-width:1px}article.container .body :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-inline-start:.5714286em;vertical-align:bottom}article.container .body :where(tbody tr):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-td-borders);border-bottom-width:1px}article.container .body :where(tbody tr:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:0}article.container .body :where(tbody td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:baseline}article.container .body :where(tfoot):not(:where([class~=not-prose],[class~=not-prose] *)){border-top-color:var(--tw-prose-th-borders);border-top-width:1px}article.container .body :where(tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:top}article.container .body :where(th,td):not(:where([class~=not-prose],[class~=not-prose] *)){text-align:start}article.container .body :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}article.container .body :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-captions);font-size:.875em;line-height:1.4285714;margin-top:.8571429em}article.container .body{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-kbd:#111827;--tw-prose-kbd-shadows:17 24 39;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-kbd:#fff;--tw-prose-invert-kbd-shadows:255 255 255;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:rgba(0,0,0,.5);--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}article.container .body :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}article.container .body :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.5em;margin-top:.5em}article.container .body :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}article.container .body :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}article.container .body :where(.prose>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}article.container .body :where(.prose>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}article.container .body :where(.prose>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}article.container .body :where(.prose>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}article.container .body :where(.prose>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}article.container .body :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}article.container .body :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}article.container .body :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.5em;padding-inline-start:1.625em}article.container .body :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}article.container .body :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}article.container .body :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-top:.5714286em;padding-inline-start:.5714286em}article.container .body :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}article.container .body :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}article.container .body :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}article.container .body :where(.prose>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(.prose>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}article.container .body{line-height:1.625;padding:1rem}@media (min-width:768px){article.container .body{font-size:1.125rem;line-height:1.7777778}article.container .body :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}article.container .body :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.2222222em;line-height:1.4545455;margin-bottom:1.0909091em;margin-top:1.0909091em}article.container .body :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.6666667em;margin-top:1.6666667em;padding-inline-start:1em}article.container .body :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:2.6666667em;line-height:1;margin-bottom:.8333333em;margin-top:0}article.container .body :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.6666667em;line-height:1.3333333;margin-bottom:1.0666667em;margin-top:1.8666667em}article.container .body :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:1.3333333em;line-height:1.5;margin-bottom:.6666667em;margin-top:1.6666667em}article.container .body :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){line-height:1.5555556;margin-bottom:.4444444em;margin-top:1.7777778em}article.container .body :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}article.container .body :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}article.container .body :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}article.container .body :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}article.container .body :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;font-size:.8888889em;padding-inline-end:.4444444em;padding-bottom:.2222222em;padding-top:.2222222em;padding-inline-start:.4444444em}article.container .body :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em}article.container .body :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8666667em}article.container .body :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em}article.container .body :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.375rem;font-size:.8888889em;line-height:1.75;margin-bottom:2em;margin-top:2em;padding-inline-end:1.5em;padding-bottom:1em;padding-top:1em;padding-inline-start:1.5em}article.container .body :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}article.container .body :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em;padding-inline-start:1.5555556em}article.container .body :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.6666667em;margin-top:.6666667em}article.container .body :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}article.container .body :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.4444444em}article.container .body :where(.md\:prose-lg>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}article.container .body :where(.md\:prose-lg>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}article.container .body :where(.md\:prose-lg>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}article.container .body :where(.md\:prose-lg>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}article.container .body :where(.md\:prose-lg>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em}article.container .body :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.8888889em;margin-top:.8888889em}article.container .body :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.3333333em;margin-top:1.3333333em}article.container .body :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.3333333em}article.container .body :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.6666667em;padding-inline-start:1.5555556em}article.container .body :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:3.1111111em;margin-top:3.1111111em}article.container .body :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5}article.container .body :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-inline-start:.75em}article.container .body :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}article.container .body :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}article.container .body :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.75em;padding-bottom:.75em;padding-top:.75em;padding-inline-start:.75em}article.container .body :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}article.container .body :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}article.container .body :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.7777778em;margin-top:1.7777778em}article.container .body :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}article.container .body :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.8888889em;line-height:1.5;margin-top:1em}article.container .body :where(.md\:prose-lg>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}article.container .body :where(.md\:prose-lg>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}}article.container .body:is(.dark *){--tw-prose-body:var(--tw-prose-invert-body);--tw-prose-headings:var(--tw-prose-invert-headings);--tw-prose-lead:var(--tw-prose-invert-lead);--tw-prose-links:var(--tw-prose-invert-links);--tw-prose-bold:var(--tw-prose-invert-bold);--tw-prose-counters:var(--tw-prose-invert-counters);--tw-prose-bullets:var(--tw-prose-invert-bullets);--tw-prose-hr:var(--tw-prose-invert-hr);--tw-prose-quotes:var(--tw-prose-invert-quotes);--tw-prose-quote-borders:var(--tw-prose-invert-quote-borders);--tw-prose-captions:var(--tw-prose-invert-captions);--tw-prose-kbd:var(--tw-prose-invert-kbd);--tw-prose-kbd-shadows:var(--tw-prose-invert-kbd-shadows);--tw-prose-code:var(--tw-prose-invert-code);--tw-prose-pre-code:var(--tw-prose-invert-pre-code);--tw-prose-pre-bg:var(--tw-prose-invert-pre-bg);--tw-prose-th-borders:var(--tw-prose-invert-th-borders);--tw-prose-td-borders:var(--tw-prose-invert-td-borders)}article.container .body h2 :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))),article.container .body h3 :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))),article.container .body h4 :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))){text-decoration-line:none}article.container .body pre{background-color:rgb(55 65 81/var(--tw-bg-opacity,1));margin-bottom:1rem;margin-top:1rem;overflow-x:auto;padding:1rem}article.container .body :not(pre)>code,article.container .body pre{border-radius:.25rem;--tw-bg-opacity:1}article.container .body :not(pre)>code{background-color:rgb(229 231 235/var(--tw-bg-opacity,1));padding:.25rem .5rem;word-break:break-all}article.container .body :not(pre)>code:is(.dark *){--tw-bg-opacity:1;background-color:rgb(75 85 99/var(--tw-bg-opacity,1))}article.container .body code:after,article.container .body code:before{display:none}article.container .body code[lang]{--tw-bg-opacity:1;background-color:rgb(75 85 99/var(--tw-bg-opacity,1));font-weight:400}article.container .body section.footnotes{margin-top:2rem}article.container .tags{display:flex;gap:.5rem}article.container .tags li{border-radius:.25rem;border-width:1px;--tw-border-opacity:1;border-color:rgb(147 197 253/var(--tw-border-opacity,1));--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1));padding-left:.5rem;padding-right:.5rem}article.container .tags li:before{content:"#"}</style>
<style>pre code .line{display:block}</style>
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/C5C27nRP.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/CggDTUjA.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/C-Zyynjc.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BxVzE-PR.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/B85PT2wF.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/B9NA5fhz.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/o5n_bVyr.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BCUbSYe6.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BIkxpzLt.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/DWb9ltmV.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/TDVEU4Do.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/Dhs5ZqF9.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/NV2JX2o6.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/Crq0LJS5.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BD80SQQ5.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/5vwZ16tV.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/D98kK3HO.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/BmQdP15E.js">
<meta name="theme-color" content="#FFF">
<meta name="mobile-web-app-capable" content="yes">
<meta property="og:type" content="website">
<meta property="og:title" content="Changkyun Kim">
<meta property="og:site_name" content="Changkyun Kim">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="description" content="몽고디비 aggregation을 페이징 할 때 성능 문제 해결기\n">
<script type="module" src="/_nuxt/C5C27nRP.js" crossorigin></script>
<script id="unhead:payload" type="application/json">{"title":"Changkyun Kim"}</script>
<link rel="preload" as="fetch" fetchpriority="low" crossorigin="anonymous" href="/_nuxt/builds/meta/81dd48f5-054f-4fcb-90d6-55c08acaf384.json"></head><body><div id="__nuxt"><div class="site"><header><div class="container"><h1><a href="/" class="">Changkyun Kim</a></h1><nav><button class="hamburger"><span class="sr-only">Menu</span><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button><menu><li><a href="/about" class="">About me</a></li><li><a href="/blog/" class="">Articles</a></li><li><a href="/contact" class="">Contact</a></li></menu></nav></div></header><!--[--><article class="container mx-auto"><!----><header><h1>몽고디비 페이징과 룩업 성능</h1><time datetime="datetime">2020년 6월 20일 토요일</time><div class="tags"><ul class="flex gap-2"><!--[--><li>dev</li><li>mongodb</li><li>nodejs</li><li>python</li><!--]--></ul></div></header><div class="body"><div><p><!--[-->몽고디비는 도큐먼트DB 특성상 기존 RDBMS와는 데이터를 다루는 철학에 차이가 조금 있다.<!--]--></p><p><!--[-->이번에 회사 프로덕트를 만들면서 여러 컬렉션을 참조하는 목록을 페이징하는 쿠에리에서 심각하게 성능저하가 일어나는 것을 발견하여 이를 해결하는 과정을 소개한다.<!--]--></p><p><!--[-->우선, 페이징을 구현하기 위해서는 전체 컬렉션 또는 커서의 일부분만 잘라내어 fetch 해줄 방법이 필요하다. 몽고디비에는 <code><!--[-->.skip()<!--]--></code> 과 <code><!--[-->.limit()<!--]--></code> 체인메소드를 기본 제공하기 때문에 이 부분에는 문제가 없다.<!--]--></p><p><!--[-->하지만 총 몇 page가 존재하는지(또는 이전/다음 페이지가 존재하는지)를 알기 위해서는 커서의 총 도큐먼트 수를 알아내야 할 필요가 있다. 과거 3.x 이전 버전에서는 우선 cursor를 만든다음 클론하여 하나는 도큐먼트 수를 세는데, 하나는 커서의 일부를 잘라내는데 사용했었다.<!--]--></p><pre class="language-js shiki shiki-themes github-dark-dimmed" style=""><!--[--><code><span class="line" line="1"><span class="szrzo">mongo</span><span class="s3aqa">&gt;</span><span class="s3aqa"> var</span><span class="szrzo"> cursor </span><span class="s3aqa">=</span><span class="szrzo"> db.contents.</span><span class="slGcm">find</span><span class="szrzo">(query)
</span></span><span class="line" line="2"><span class="szrzo">mongo</span><span class="s3aqa">&gt;</span><span class="s3aqa"> var</span><span class="szrzo"> total </span><span class="s3aqa">=</span><span class="szrzo"> cursor.</span><span class="slGcm">clone</span><span class="szrzo">().</span><span class="slGcm">count</span><span class="szrzo">()
</span></span><span class="line" line="3"><span class="szrzo">mongo</span><span class="s3aqa">&gt;</span><span class="szrzo"> cursor.</span><span class="slGcm">skip</span><span class="szrzo">((page </span><span class="s3aqa">-</span><span class="sSMXU"> 1</span><span class="szrzo">) </span><span class="s3aqa">*</span><span class="szrzo"> itemPerPage).</span><span class="slGcm">limit</span><span class="szrzo">(itemPerPage)
</span></span></code><!--]--></pre><h2 id="페이징할-문서-전체의-갯수-가져오기"><a href="#페이징할-문서-전체의-갯수-가져오기"><!--[-->페이징할 문서 전체의 갯수 가져오기<!--]--></a></h2><p><!--[-->4.x 부터는 <code><!--[-->cursor.count()<!--]--></code> 메소드 사용을 지양하고 <code><!--[-->collection.countDocuments(query)<!--]--></code> 또는 <code><!--[-->collection.estimatedDocumentCount(query)<!--]--></code> 를 대신 사용할 것을 권장할 뿐 아니라, 일부 드라이버에서는 이미 <code><!--[-->cursor.count()<!--]--></code> 메소드가 deprecate 되어있다. 여기에는 함정이 숨어있는데, 단순 <code><!--[-->collection.find()<!--]--></code>가 아닌 aggregation의 경우에는 해당되지 않는다는 점이다.<!--]--></p><p><!--[-->aggregation을 페이징 하려면 <code><!--[-->AggregationPipeline.count()<!--]--></code> 를 조회하는 대신 pipeline의 일정 단계 이후 스테이지를 분기하여 각각 <code><!--[-->도큐먼트 수<!--]--></code> 및 <code><!--[-->페이징된 커서<!--]--></code> 를 얻는데 사용해야 한다. 스테이지를 여러개로 분리하는데는 <code><!--[-->$facet<!--]--></code> 스테이지를 활용하면 한번의 오퍼레이션으로 두가지 정보를 한꺼번에 가져올 수 있다.<!--]--></p><p><!--[-->(여기서부터는 헬퍼 코드를 작성했기 때문에, mongo shell 대신 각종 언어 드라이버 기준으로...)<!--]--></p><pre class="language-python shiki shiki-themes github-dark-dimmed" style=""><!--[--><code><span class="line" line="1"><span class="slGcm">@dataclass
</span></span><span class="line" line="2"><span class="s3aqa">class</span><span class="skFXu"> PagedAggregation</span><span class="szrzo">(</span><span class="sSMXU">object</span><span class="szrzo">):
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span class="szrzo">    page: </span><span class="sSMXU">int</span><span class="s3aqa"> =</span><span class="sSMXU"> 1
</span></span><span class="line" line="5"><span class="szrzo">    page_size: </span><span class="sSMXU">int</span><span class="s3aqa"> =</span><span class="sSMXU"> 10
</span></span><span class="line" line="6"><span class="szrzo">    total: </span><span class="sSMXU">int</span><span class="s3aqa"> =</span><span class="sSMXU"> 0
</span></span><span class="line" line="7"><span class="szrzo">    items: List[</span><span class="sSMXU">dict</span><span class="szrzo">] </span><span class="s3aqa">=</span><span class="szrzo"> field(</span><span class="skFXu">default_factory</span><span class="s3aqa">=</span><span class="sSMXU">list</span><span class="szrzo">)
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span class="s3aqa">    def</span><span class="sSMXU"> __iter__</span><span class="szrzo">(self) -&gt; Generator[</span><span class="sSMXU">dict</span><span class="szrzo">]:
</span></span><span class="line" line="10"><span class="s3aqa">        yield from</span><span class="sSMXU"> self</span><span class="szrzo">.items
</span></span><span class="line" line="11"><span emptylineplaceholder="true">
</span></span><span class="line" line="12"><span class="s3aqa">    def</span><span class="slGcm"> __json__</span><span class="szrzo">(self) -&gt; </span><span class="sSMXU">dict</span><span class="szrzo">:
</span></span><span class="line" line="13"><span class="s3aqa">        return</span><span class="szrzo"> {
</span></span><span class="line" line="14"><span class="s6sc0">            &#39;page&#39;</span><span class="szrzo">: </span><span class="sSMXU">self</span><span class="szrzo">.page,
</span></span><span class="line" line="15"><span class="s6sc0">            &#39;pageSize&#39;</span><span class="szrzo">: </span><span class="sSMXU">self</span><span class="szrzo">.page_size,
</span></span><span class="line" line="16"><span class="s6sc0">            &#39;total&#39;</span><span class="szrzo">: </span><span class="sSMXU">self</span><span class="szrzo">.total,
</span></span><span class="line" line="17"><span class="s6sc0">            &#39;totalPages&#39;</span><span class="szrzo">: math.ceil(</span><span class="sSMXU">self</span><span class="szrzo">.total </span><span class="s3aqa">/</span><span class="sSMXU"> self</span><span class="szrzo">.page_size),
</span></span><span class="line" line="18"><span class="s6sc0">            &#39;items&#39;</span><span class="szrzo">: </span><span class="sSMXU">self</span><span class="szrzo">.items
</span></span><span class="line" line="19"><span class="szrzo">        }
</span></span><span class="line" line="20"><span emptylineplaceholder="true">
</span></span><span class="line" line="21"><span class="s3aqa">def</span><span class="slGcm"> paged</span><span class="szrzo">(collection: Collection, pipeline: List</span><span class="s3aqa">=</span><span class="szrzo">[], page</span><span class="s3aqa">=</span><span class="sSMXU">1</span><span class="szrzo">, page_size</span><span class="s3aqa">=</span><span class="sSMXU">10</span><span class="szrzo">) -&gt; PagedAggregation:
</span></span><span class="line" line="22"><span class="s6sc0">    &quot;&quot;&quot;
</span></span><span class="line" line="23"><span class="s6sc0">    generates an aggregation facet pipeline, then fetch
</span></span><span class="line" line="24"><span class="s6sc0">    &quot;&quot;&quot;
</span></span><span class="line" line="25"><span class="szrzo">    pager </span><span class="s3aqa">=</span><span class="szrzo"> {</span><span class="s6sc0">&#39;$facet&#39;</span><span class="szrzo">: {
</span></span><span class="line" line="26"><span class="s6sc0">        &#39;metadata&#39;</span><span class="szrzo">: [
</span></span><span class="line" line="27"><span class="szrzo">            {</span><span class="s6sc0">&#39;$count&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;total&#39;</span><span class="szrzo">},
</span></span><span class="line" line="28"><span class="szrzo">            {</span><span class="s6sc0">&#39;$addFields&#39;</span><span class="szrzo">: {</span><span class="s6sc0">&#39;page&#39;</span><span class="szrzo">: page}}
</span></span><span class="line" line="29"><span class="szrzo">        ],
</span></span><span class="line" line="30"><span class="s6sc0">        &#39;items&#39;</span><span class="szrzo">: [
</span></span><span class="line" line="31"><span class="szrzo">            {</span><span class="s6sc0">&#39;$skip&#39;</span><span class="szrzo">: (page </span><span class="s3aqa">-</span><span class="sSMXU"> 1</span><span class="szrzo">) </span><span class="s3aqa">*</span><span class="szrzo"> page_size},
</span></span><span class="line" line="32"><span class="szrzo">            {</span><span class="s6sc0">&#39;$limit&#39;</span><span class="szrzo">: page_size}
</span></span><span class="line" line="33"><span class="szrzo">        ]
</span></span><span class="line" line="34"><span class="szrzo">    }}
</span></span><span class="line" line="35"><span emptylineplaceholder="true">
</span></span><span class="line" line="36"><span class="szrzo">    paged_pipeline </span><span class="s3aqa">=</span><span class="szrzo"> pipeline[:]
</span></span><span class="line" line="37"><span class="szrzo">    paged_pipeline.append(pager)
</span></span><span class="line" line="38"><span class="szrzo">    doc </span><span class="s3aqa">=</span><span class="sSMXU"> next</span><span class="szrzo">(collection.aggregate(paged_pipeline))
</span></span><span class="line" line="39"><span emptylineplaceholder="true">
</span></span><span class="line" line="40"><span class="s3aqa">    return</span><span class="szrzo"> PagedAggregation(
</span></span><span class="line" line="41"><span class="skFXu">        page</span><span class="s3aqa">=</span><span class="szrzo">page,
</span></span><span class="line" line="42"><span class="skFXu">        page_size</span><span class="s3aqa">=</span><span class="szrzo">page_size,
</span></span><span class="line" line="43"><span class="skFXu">        total</span><span class="s3aqa">=</span><span class="szrzo">doc[</span><span class="s6sc0">&#39;metadata&#39;</span><span class="szrzo">][</span><span class="sSMXU">0</span><span class="szrzo">][</span><span class="s6sc0">&#39;total&#39;</span><span class="szrzo">],
</span></span><span class="line" line="44"><span class="skFXu">        items</span><span class="s3aqa">=</span><span class="szrzo">doc[</span><span class="s6sc0">&#39;items&#39;</span><span class="szrzo">]
</span></span><span class="line" line="45"><span class="szrzo">    )
</span></span></code><!--]--></pre><p><!--[-->구글링과 스택넘침질로 얻은 각종 스킬들을 조합하여 나름 꽤 심플하고 합리적으로 aggregate의 페이징을 정리한 듯 했다<a href="#user-content-fn-1" aria-described-by="footnote-label" data-footnote-ref id="user-content-fnref-1"><!--[-->1<!--]--></a>. 하지만 문서 수가 수십만을 넘기 시작하면서, 파이프라인에서 다른 컬렉션을 $lookup 하는 빈도가 늘어나면서 성능이 심각할 정도로 나빠지기 시작했다.<!--]--></p><p><!--[-->개인적으로는 실행 계획(explain)을 눈으로 짐작하기 쉽지 않은 SQL보다 각 단계에서 할 일을 순차적으로 명시하는 aggregation pipeline 쪽이 훨씬 낫다고 생각했었다. 물론 그 사실에는 변함이 없지만, 데이터를 &quot;관계&quot;로 바라보는 RDBMS와 다르게 &quot;도큐먼트&quot;로 바라보는 몽고디비의 철학에서 내가 원하는 &quot;결과&quot;만을 목적으로 파이프라인을 짜다보면 자신이 놓은 함정에 걸리게 되는 경우가 생긴다.<!--]--></p><p><!--[-->위에 작성한 <code><!--[-->paged<!--]--></code> 헬퍼를 이용하여 평균 20여개의 코멘트가 달린 100만건의 블로그 글 목록에서 내가 작성한 글의 일부 페이지를 가져오려고 한다면,<!--]--></p><pre class="language-python shiki shiki-themes github-dark-dimmed" style=""><!--[--><code><span class="line" line="1"><span class="szrzo">pipeline </span><span class="s3aqa">=</span><span class="szrzo"> [
</span></span><span class="line" line="2"><span class="szrzo">  {</span><span class="s6sc0">&#39;$match&#39;</span><span class="szrzo">: {
</span></span><span class="line" line="3"><span class="s6sc0">    &#39;author_id&#39;</span><span class="szrzo">: me
</span></span><span class="line" line="4"><span class="szrzo">  }},
</span></span><span class="line" line="5"><span class="szrzo">  {</span><span class="s6sc0">&#39;$lookup&#39;</span><span class="szrzo">: {
</span></span><span class="line" line="6"><span class="s6sc0">    &#39;from&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;comments&#39;</span><span class="szrzo">,
</span></span><span class="line" line="7"><span class="s6sc0">    &#39;localField&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;_id&#39;</span><span class="szrzo">,
</span></span><span class="line" line="8"><span class="s6sc0">    &#39;foreignField&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;article_id&#39;</span><span class="szrzo">,
</span></span><span class="line" line="9"><span class="s6sc0">    &#39;as&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;comments&#39;
</span></span><span class="line" line="10"><span class="szrzo">  }}
</span></span><span class="line" line="11"><span class="szrzo">]
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span class="szrzo">paged(db.articles, pipeline, </span><span class="skFXu">page</span><span class="s3aqa">=</span><span class="sSMXU">100</span><span class="szrzo">, </span><span class="skFXu">page_size</span><span class="s3aqa">=</span><span class="sSMXU">10</span><span class="szrzo">)
</span></span></code><!--]--></pre><p><!--[-->이런 식이 될 것이다.<!--]--></p><p><!--[--><code><!--[-->$lookup<!--]--></code> 스테이지가 <code><!--[-->$skip<!--]--></code>, <code><!--[-->$limit<!--]--></code> 스테이지보다 앞서 등장하기 때문에 10개의 도큐먼트를 얻기 전에 100만건 article 모두에 대한 comment 를 미리 lookup 하게 되어, 사실상 문서마다 20개의 댓글을 포함하여 총 2000만개의 도큐먼트를 조회한 후 그중 일부를 가져오게 된다. aggregation pipeline은 메모리상에서 최대 100MB만 사용할 수 있는 제약사항이 있기 때문에 스테이지의 일부 단계에서 문서 갯수가 많거나 메모리를 초과할 것으로 예상된다면 미리 <code><!--[-->allowDiskUse<!--]--></code> 옵션을 활성화 시켜 두지 않았다면 최종 10개 문서(x20개 댓글)를 가져오기 전에 이미 메모리 부족 에러를 만날 가능성도 있다.<!--]--></p><p><!--[-->위 예시의 경우는 페이징을 마치 RDBMS의 <code><!--[-->LIMIT n, m<!--]--></code> 으로 다루듯 마지막 단계에만 페이징을 위한 스테이지를 추가하는 경우를 보여주는 예시로, 몽고디비에서 쉽게 저지를 수 있는 실수에 해당한다. <code><!--[-->$lookup<!--]--></code> 스테이지를 직접 <code><!--[-->$limit<!--]--></code> 스테이지 다음으로 옮겨두면 극적으로 성능 향상을 기대할 수 있다.<!--]--></p><p><!--[--><code><!--[-->$lookup<!--]--></code>된 외래 도큐먼트의 속성을 <code><!--[-->$match<!--]--></code> 스테이지에서 활용하고자 하는 경우엔 이야기가 달라진다.<!--]--></p><blockquote><!--[--><p><!--[-->19세 미만 미성년자가 작성한 글과 댓글을 가져오려는 경우..<!--]--></p><!--]--></blockquote><pre class="language-python shiki shiki-themes github-dark-dimmed" style=""><!--[--><code><span class="line" line="1"><span class="szrzo">pipeline </span><span class="s3aqa">=</span><span class="szrzo"> [
</span></span><span class="line" line="2"><span class="szrzo">  {</span><span class="s6sc0">&#39;$lookup&#39;</span><span class="szrzo">: {
</span></span><span class="line" line="3"><span class="s6sc0">    &#39;from&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;author&#39;</span><span class="szrzo">,
</span></span><span class="line" line="4"><span class="s6sc0">    &#39;localField&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;author_id&#39;</span><span class="szrzo">,
</span></span><span class="line" line="5"><span class="s6sc0">    &#39;foreignField&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;_id&#39;</span><span class="szrzo">,
</span></span><span class="line" line="6"><span class="s6sc0">    &#39;as&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;author&#39;
</span></span><span class="line" line="7"><span class="szrzo">  }},
</span></span><span class="line" line="8"><span class="szrzo">  {</span><span class="s6sc0">&#39;$unwind&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;$author&#39;</span><span class="szrzo">},
</span></span><span class="line" line="9"><span class="szrzo">  {</span><span class="s6sc0">&#39;$match&#39;</span><span class="szrzo">: {
</span></span><span class="line" line="10"><span class="s6sc0">    &#39;author.age&#39;</span><span class="szrzo">: {</span><span class="s6sc0">&#39;$lte&#39;</span><span class="szrzo">: </span><span class="sSMXU">19</span><span class="szrzo">}
</span></span><span class="line" line="11"><span class="szrzo">  }},
</span></span><span class="line" line="12"><span class="szrzo">  {</span><span class="s6sc0">&#39;$lookup&#39;</span><span class="szrzo">: {
</span></span><span class="line" line="13"><span class="s6sc0">    &#39;from&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;comments&#39;</span><span class="szrzo">,
</span></span><span class="line" line="14"><span class="s6sc0">    &#39;localField&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;_id&#39;</span><span class="szrzo">,
</span></span><span class="line" line="15"><span class="s6sc0">    &#39;foreignField&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;article_id&#39;</span><span class="szrzo">,
</span></span><span class="line" line="16"><span class="s6sc0">    &#39;as&#39;</span><span class="szrzo">: </span><span class="s6sc0">&#39;comments&#39;
</span></span><span class="line" line="17"><span class="szrzo">  }}
</span></span><span class="line" line="18"><span class="szrzo">]
</span></span></code><!--]--></pre><p><!--[-->이런 경우는 3번째에 등장하는 <code><!--[-->$match<!--]--></code> 스테이지에서 <code><!--[-->author.age<!--]--></code>를 조건으로 사용하기 위해 미리 <code><!--[-->$lookup<!--]--></code> 하지 않을 수 없기 때문에 <code><!--[-->$lookup<!--]--></code>의 순서를 뒤로 미뤄 성능 향상을 기대할 수는 없다. RDBMS에서는 자주 등장할 수 있는 쿠에리지만 <code><!--[-->JOIN<!--]--></code>되는 필드에 외래키, 인덱스가 적절히 걸려있다면 심각한 성능 저하가 발생하지는 않는다.<!--]--></p><p><!--[--><code><!--[-->$lookup<!--]--></code>을 최적화 하는 과정은 아직도 진행단계고 좀 긴 넋두리가 필요하므로 다음기회(가 있다면)에 소개하기로 한다.<!--]--></p><h2 id="facet-퍼포먼스-문제"><a href="#facet-퍼포먼스-문제"><!--[-->$facet 퍼포먼스 문제<!--]--></a></h2><p><!--[-->두번째로 발견한 성능저하의 문제는, <code><!--[-->$facet<!--]--></code>의 퍼포먼스가 너무 좋지 않다. 하나의 pipeline을 둘로 나누어 병렬로 실행한다 라는 아이디어는 깜찍하고 좋았지만, 실제 실행 단계에서 나뉘기 전 스테이지까지의 결과를 재활용하기는 하는건지 의심스러울 정도로 <code><!--[-->$facet<!--]--></code>가 등장하는 aggregation은 성능이 항상 좋지 않았다.<!--]--></p><p><!--[-->또한, 문서 수 및 문서 목록을 하나의 파이프라인에서 모두 연산해 올 때 까지 대기해야 하므로 replicaSet의 분산 처리 도움을 별로 받지 못한다.<!--]--></p><p><!--[-->nodejs 에서는 mongoos 라이브러리의 구현을 조금 참조하여 <code><!--[-->$facet<!--]--></code>를 쓰지 않고 두번에 나누어 (동시에)실행하도록 paged 헬퍼를 수정했다.<!--]--></p><pre class="language-js shiki shiki-themes github-dark-dimmed" style=""><!--[--><code><span class="line" line="1"><span class="sca0q">/**
</span></span><span class="line" line="2"><span class="sca0q"> * 몽고디비 aggregation 을 페이징한다
</span></span><span class="line" line="3"><span class="sca0q"> * </span><span class="s3aqa">@async
</span></span><span class="line" line="4"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {Collection}</span><span class="szrzo"> collection</span><span class="sca0q"> 몽고디비 컬렉션
</span></span><span class="line" line="5"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {object | object[]}</span><span class="szrzo"> condition</span><span class="sca0q"> query 또는 aggregation 파이프라인
</span></span><span class="line" line="6"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {object}</span><span class="szrzo"> [options]
</span></span><span class="line" line="7"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {number}</span><span class="szrzo"> [options.page </span><span class="s3aqa">=</span><span class="szrzo"> 1]</span><span class="sca0q"> 페이지번호
</span></span><span class="line" line="8"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {number}</span><span class="szrzo"> [options.pageSize </span><span class="s3aqa">=</span><span class="szrzo"> 10]</span><span class="sca0q"> 페이지당 문서 갯수
</span></span><span class="line" line="9"><span class="sca0q"> * </span><span class="s3aqa">@returns</span><span class="skFXu"> {Promise&lt;PagedCursor&gt;}
</span></span><span class="line" line="10"><span class="sca0q"> */
</span></span><span class="line" line="11"><span class="s3aqa">export</span><span class="s3aqa"> const</span><span class="slGcm"> paged</span><span class="s3aqa"> =</span><span class="szrzo"> (
</span></span><span class="line" line="12"><span class="skFXu">  collection</span><span class="szrzo">,
</span></span><span class="line" line="13"><span class="skFXu">  condition</span><span class="szrzo">,
</span></span><span class="line" line="14"><span class="szrzo">  { </span><span class="skFXu">page</span><span class="s3aqa"> =</span><span class="sSMXU"> 1</span><span class="szrzo">, </span><span class="skFXu">pageSize</span><span class="s3aqa"> =</span><span class="sSMXU"> 10</span><span class="szrzo"> } </span><span class="s3aqa">=</span><span class="szrzo"> {}
</span></span><span class="line" line="15"><span class="szrzo">) </span><span class="s3aqa">=&gt;</span><span class="szrzo"> {
</span></span><span class="line" line="16"><span class="s3aqa">  let</span><span class="szrzo"> pipeline </span><span class="s3aqa">=</span><span class="szrzo"> [];
</span></span><span class="line" line="17"><span class="s3aqa">  if</span><span class="szrzo"> (Array.</span><span class="slGcm">isArray</span><span class="szrzo">(condition)) {
</span></span><span class="line" line="18"><span class="sca0q">    // aggregation pipeline인 경우
</span></span><span class="line" line="19"><span class="szrzo">    pipeline.push.</span><span class="slGcm">apply</span><span class="szrzo">(pipeline, condition);
</span></span><span class="line" line="20"><span class="szrzo">  } </span><span class="s3aqa">else</span><span class="szrzo"> {
</span></span><span class="line" line="21"><span class="sca0q">    // query only인 경우
</span></span><span class="line" line="22"><span class="szrzo">    pipeline.</span><span class="slGcm">push</span><span class="szrzo">({ $match: condition });
</span></span><span class="line" line="23"><span class="szrzo">  }
</span></span><span class="line" line="24"><span emptylineplaceholder="true">
</span></span><span class="line" line="25"><span class="s3aqa">  const</span><span class="sSMXU"> countPipeline</span><span class="s3aqa"> =</span><span class="szrzo"> [</span><span class="s3aqa">...</span><span class="szrzo">pipeline].</span><span class="slGcm">filter</span><span class="szrzo">((</span><span class="skFXu">elm</span><span class="szrzo">) </span><span class="s3aqa">=&gt;</span><span class="s3aqa"> !</span><span class="szrzo">elm[</span><span class="s6sc0">&quot;$sort&quot;</span><span class="szrzo">]);
</span></span><span class="line" line="26"><span class="szrzo">  countPipeline.</span><span class="slGcm">push</span><span class="szrzo">({ $group: { _id: </span><span class="sSMXU">null</span><span class="szrzo">, count: { $sum: </span><span class="sSMXU">1</span><span class="szrzo"> } } });
</span></span><span class="line" line="27"><span emptylineplaceholder="true">
</span></span><span class="line" line="28"><span class="s3aqa">  const</span><span class="sSMXU"> pagedPipeline</span><span class="s3aqa"> =</span><span class="szrzo"> [</span><span class="s3aqa">...</span><span class="szrzo">pipeline];
</span></span><span class="line" line="29"><span class="szrzo">  pagedPipeline.</span><span class="slGcm">push</span><span class="szrzo">({ $skip: (page </span><span class="s3aqa">-</span><span class="sSMXU"> 1</span><span class="szrzo">) </span><span class="s3aqa">*</span><span class="szrzo"> pageSize });
</span></span><span class="line" line="30"><span class="szrzo">  pagedPipeline.</span><span class="slGcm">push</span><span class="szrzo">({ $limit: pageSize });
</span></span><span class="line" line="31"><span emptylineplaceholder="true">
</span></span><span class="line" line="32"><span class="s3aqa">  return</span><span class="sSMXU"> Promise</span><span class="szrzo">.</span><span class="slGcm">all</span><span class="szrzo">([
</span></span><span class="line" line="33"><span class="szrzo">    collection.</span><span class="slGcm">aggregate</span><span class="szrzo">(pagedPipeline, { allowDiskUse: </span><span class="sSMXU">true</span><span class="szrzo"> }).</span><span class="slGcm">toArray</span><span class="szrzo">(),
</span></span><span class="line" line="34"><span class="szrzo">    collection.</span><span class="slGcm">aggregate</span><span class="szrzo">(countPipeline, { allowDiskUse: </span><span class="sSMXU">true</span><span class="szrzo"> }).</span><span class="slGcm">toArray</span><span class="szrzo">(),
</span></span><span class="line" line="35"><span class="szrzo">  ]).</span><span class="slGcm">then</span><span class="szrzo">(([</span><span class="skFXu">items</span><span class="szrzo">, </span><span class="skFXu">countResult</span><span class="szrzo">]) </span><span class="s3aqa">=&gt;</span><span class="szrzo"> {
</span></span><span class="line" line="36"><span class="s3aqa">    const</span><span class="sSMXU"> total</span><span class="s3aqa"> =</span><span class="szrzo"> countResult.</span><span class="sSMXU">length</span><span class="s3aqa"> &gt;</span><span class="sSMXU"> 0</span><span class="s3aqa"> ?</span><span class="szrzo"> countResult.</span><span class="slGcm">shift</span><span class="szrzo">().count </span><span class="s3aqa">:</span><span class="sSMXU"> 0</span><span class="szrzo">;
</span></span><span class="line" line="37"><span class="s3aqa">    const</span><span class="sSMXU"> totalPages</span><span class="s3aqa"> =</span><span class="szrzo"> Math.</span><span class="slGcm">ceil</span><span class="szrzo">(total </span><span class="s3aqa">/</span><span class="szrzo"> pageSize);
</span></span><span class="line" line="38"><span class="s3aqa">    return</span><span class="szrzo"> {
</span></span><span class="line" line="39"><span class="szrzo">      page,
</span></span><span class="line" line="40"><span class="szrzo">      pageSize,
</span></span><span class="line" line="41"><span class="szrzo">      total,
</span></span><span class="line" line="42"><span class="szrzo">      totalPages,
</span></span><span class="line" line="43"><span class="szrzo">      items,
</span></span><span class="line" line="44"><span class="szrzo">    };
</span></span><span class="line" line="45"><span class="szrzo">  });
</span></span><span class="line" line="46"><span class="szrzo">};
</span></span></code><!--]--></pre><h2 id="lazy-loading-전략"><a href="#lazy-loading-전략"><!--[-->lazy loading 전략<!--]--></a></h2><p><!--[--><code><!--[-->$lookup<!--]--></code> 스테이지의 목적이 단순히 다른 컬렉션의 일부 정보를 가져와 도큐먼트의 속성에 끼워넣어 주기를 바라기만 하는 경우라면 굳이 <code><!--[-->$lookup<!--]--></code> 스테이지를 활용하지 않고, 연관 도큐먼트를 별도로 조회한 다음 결과 목록에 확장시켜주어도 성능엔 큰 차이가 없다. (orm 의 eager/lazy loading 전략과 비슷)<!--]--></p><p><!--[-->사실은 원시 컬렉션의 외래키를 수집하여 어플리케이션 서버에서 다시 두번째 쿠에리를 만들어 DB서버에 전송하는 것을 비효율적이지만, 어플리케이션 서버와 DB서버의 네트워크 거리가 충분히 가까운 경우라면 <code><!--[-->$lookup<!--]--></code> 을 이용하여 몽고디비 내에서 연관 컬렉션을 조회하는 것과 거의 성능의 차이가 없고 어떤 경우는 더 좋은 경우도 있었다.<!--]--></p><p><!--[-->이런 역할을 하는 <code><!--[-->lookup()<!--]--></code> 헬퍼를 nodejs 버전으로 작성했다. 파라메터 종류는 <code><!--[-->$lookup($aggregation)<!--]--></code> 과 거의 같다.<!--]--></p><pre class="language-js shiki shiki-themes github-dark-dimmed" style=""><!--[--><code><span class="line" line="1"><span class="sca0q">/**
</span></span><span class="line" line="2"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {DataBase}</span><span class="szrzo"> db
</span></span><span class="line" line="3"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {object}</span><span class="szrzo"> information
</span></span><span class="line" line="4"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {string}</span><span class="szrzo"> information.from</span><span class="sca0q"> 참조할 컬렉션 이름
</span></span><span class="line" line="5"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {string}</span><span class="szrzo"> information.localField</span><span class="sca0q"> 외래키에 대응할 로컬 키 이름
</span></span><span class="line" line="6"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {string}</span><span class="szrzo"> information.foreignField</span><span class="sca0q"> 왜래키 이름
</span></span><span class="line" line="7"><span class="sca0q"> * </span><span class="s3aqa">@param</span><span class="skFXu"> {string}</span><span class="szrzo"> information.as</span><span class="sca0q"> 참조된 왜래 컬렉션의 아이템을 매핑할 속성명
</span></span><span class="line" line="8"><span class="sca0q"> * </span><span class="s3aqa">@returns</span><span class="skFXu"> {lookup~filler}
</span></span><span class="line" line="9"><span class="sca0q"> */
</span></span><span class="line" line="10"><span class="s3aqa">export</span><span class="s3aqa"> const</span><span class="slGcm"> lookup</span><span class="s3aqa"> =</span><span class="szrzo"> (</span><span class="skFXu">db</span><span class="szrzo">, {</span><span class="skFXu">from</span><span class="szrzo">, </span><span class="skFXu">localField</span><span class="szrzo">, </span><span class="skFXu">foreignField</span><span class="szrzo">, </span><span class="skFXu">as</span><span class="szrzo">, </span><span class="skFXu">project</span><span class="s3aqa"> =</span><span class="szrzo"> {}}) </span><span class="s3aqa">=&gt;</span><span class="szrzo"> {
</span></span><span class="line" line="11"><span class="sca0q">  /**
</span></span><span class="line" line="12"><span class="sca0q">   * </span><span class="s3aqa">@function</span><span class="skFXu"> lookup~filler
</span></span><span class="line" line="13"><span class="sca0q">   * </span><span class="s3aqa">@returns</span><span class="skFXu"> {PagedCursor}
</span></span><span class="line" line="14"><span class="sca0q">   */
</span></span><span class="line" line="15"><span class="s3aqa">  return</span><span class="szrzo"> ({</span><span class="skFXu">items</span><span class="szrzo">, </span><span class="s3aqa">...</span><span class="skFXu">rest</span><span class="szrzo">}) </span><span class="s3aqa">=&gt;</span><span class="szrzo"> {
</span></span><span class="line" line="16"><span class="s3aqa">    const</span><span class="sSMXU"> ids</span><span class="s3aqa"> =</span><span class="szrzo"> items.</span><span class="slGcm">map</span><span class="szrzo">(</span><span class="skFXu">item</span><span class="s3aqa"> =&gt;</span><span class="szrzo"> item[localField])
</span></span><span class="line" line="17"><span class="s3aqa">    return</span><span class="szrzo"> db.</span><span class="slGcm">collection</span><span class="szrzo">(from).</span><span class="slGcm">find</span><span class="szrzo">({
</span></span><span class="line" line="18"><span class="szrzo">      [foreignField]: {$in: ids}
</span></span><span class="line" line="19"><span class="szrzo">    }, {$project: project}).</span><span class="slGcm">toArray</span><span class="szrzo">().</span><span class="slGcm">then</span><span class="szrzo">(</span><span class="skFXu">props</span><span class="s3aqa"> =&gt;</span><span class="szrzo"> {
</span></span><span class="line" line="20"><span class="s3aqa">      const</span><span class="sSMXU"> propIds</span><span class="s3aqa"> =</span><span class="szrzo"> props.</span><span class="slGcm">map</span><span class="szrzo">(</span><span class="skFXu">prop</span><span class="s3aqa"> =&gt;</span><span class="s6sc0"> &#39;&#39;</span><span class="s3aqa"> +</span><span class="szrzo"> prop[foreignField])
</span></span><span class="line" line="21"><span class="s3aqa">      return</span><span class="szrzo"> {items: items.</span><span class="slGcm">map</span><span class="szrzo">(</span><span class="skFXu">item</span><span class="s3aqa"> =&gt;</span><span class="szrzo"> {
</span></span><span class="line" line="22"><span class="s3aqa">        let</span><span class="szrzo"> index </span><span class="s3aqa">=</span><span class="szrzo"> propIds.</span><span class="slGcm">indexOf</span><span class="szrzo">(</span><span class="s6sc0">&#39;&#39;</span><span class="s3aqa"> +</span><span class="szrzo"> item[localField])
</span></span><span class="line" line="23"><span class="s3aqa">        if</span><span class="szrzo"> (index </span><span class="s3aqa">&gt;</span><span class="s3aqa"> -</span><span class="sSMXU">1</span><span class="szrzo">) {
</span></span><span class="line" line="24"><span class="szrzo">          item[as] </span><span class="s3aqa">=</span><span class="szrzo"> props[index]
</span></span><span class="line" line="25"><span class="szrzo">        }
</span></span><span class="line" line="26"><span class="s3aqa">        return</span><span class="szrzo"> item
</span></span><span class="line" line="27"><span class="szrzo">      }), </span><span class="s3aqa">...</span><span class="szrzo">rest}
</span></span><span class="line" line="28"><span class="szrzo">    })
</span></span><span class="line" line="29"><span class="szrzo">  }
</span></span><span class="line" line="30"><span class="szrzo">}
</span></span><span class="line" line="31"><span emptylineplaceholder="true">
</span></span><span class="line" line="32"><span class="sca0q">/**
</span></span><span class="line" line="33"><span class="sca0q"> * 여러개의 lookup을 동시에 수행한다
</span></span><span class="line" line="34"><span class="sca0q"> */
</span></span><span class="line" line="35"><span class="s3aqa">export</span><span class="s3aqa"> const</span><span class="slGcm"> lookupAll</span><span class="s3aqa"> =</span><span class="szrzo"> (</span><span class="skFXu">db</span><span class="szrzo">, </span><span class="s3aqa">...</span><span class="skFXu">desires</span><span class="szrzo">) </span><span class="s3aqa">=&gt;</span><span class="szrzo"> {
</span></span><span class="line" line="36"><span class="s3aqa">  return</span><span class="szrzo"> ({</span><span class="skFXu">items</span><span class="szrzo">, </span><span class="s3aqa">...</span><span class="skFXu">rest</span><span class="szrzo">}) </span><span class="s3aqa">=&gt;</span><span class="sSMXU"> Promise</span><span class="szrzo">.</span><span class="slGcm">all</span><span class="szrzo">(desires.</span><span class="slGcm">map</span><span class="szrzo">(</span><span class="skFXu">desire</span><span class="s3aqa"> =&gt;</span><span class="slGcm"> lookup</span><span class="szrzo">(db, desire)({items, </span><span class="s3aqa">...</span><span class="szrzo">rest})).</span><span class="slGcm">then</span><span class="szrzo">(([</span><span class="skFXu">r</span><span class="szrzo">]) </span><span class="s3aqa">=&gt;</span><span class="szrzo"> r)
</span></span><span class="line" line="37"><span class="szrzo">}
</span></span></code><!--]--></pre><p><!--[-->이렇게 사용한다.<!--]--></p><pre class="language-js shiki shiki-themes github-dark-dimmed" style=""><!--[--><code><span class="line" line="1"><span class="slGcm">paged</span><span class="szrzo">(db.</span><span class="slGcm">collection</span><span class="szrzo">(</span><span class="s6sc0">&quot;galaxy&quot;</span><span class="szrzo">), [{ $match: { answer: </span><span class="sSMXU">42</span><span class="szrzo"> } }], {
</span></span><span class="line" line="2"><span class="szrzo">  page,
</span></span><span class="line" line="3"><span class="szrzo">  pageSize,
</span></span><span class="line" line="4"><span class="szrzo">}).</span><span class="slGcm">then</span><span class="szrzo">(
</span></span><span class="line" line="5"><span class="slGcm">  lookup</span><span class="szrzo">(db, {
</span></span><span class="line" line="6"><span class="szrzo">    from: </span><span class="s6sc0">&quot;hitchiker&quot;</span><span class="szrzo">,
</span></span><span class="line" line="7"><span class="szrzo">    localField: </span><span class="s6sc0">&quot;_id&quot;</span><span class="szrzo">,
</span></span><span class="line" line="8"><span class="szrzo">    foreignField: </span><span class="s6sc0">&quot;galaxy_id&quot;</span><span class="szrzo">,
</span></span><span class="line" line="9"><span class="szrzo">    as: </span><span class="s6sc0">&quot;hitchhikers&quot;</span><span class="szrzo">,
</span></span><span class="line" line="10"><span class="szrzo">  })
</span></span><span class="line" line="11"><span class="szrzo">);
</span></span></code><!--]--></pre><p><!--[-->요즘은 대부분 그렇지 않지만 RDBMS의 <code><!--[-->LIMIT n, m<!--]--></code> 만으로 문서의 페이징을 하는 경우에도 100만건 정도의 문서에서는 꽤 성능이 나오지 않았던 과거를 떠올려본다.<!--]--></p><p><!--[-->프로그램을 짜다 보면 데이터 설계 당시의 의도와는 다르게 복잡한 조회 조건이나 외래 키 없는 다른 데이터 컬렉션을 참조하고 싶다는 요구를 종종 받게 된다. 이때마다 인덱스나 외래키를 추가할 수는 없는 일이다. 결국 상황에 맞는 정교한 pipeline을 매번 잘 짜거나, 언어레벨의 서포트로 극뽁하는 수 밖에..<!--]--></p><p><!--[-->조금은 무책임한 <code><!--[-->$lookup<!--]--></code>과 <code><!--[-->$facet<!--]--></code>의 퍼포먼스 문제로 약간은 당황했지만, mongodb만의 문제는 아닌 것으로.. 계속해서 발전하는 몽고디비가 되기를<!--]--></p><h2 id="footnotes"><a href="#footnotes"><!--[-->Footnotes<!--]--></a></h2><ol><!--[--><li><!--[-->실제로 일반적인 경우엔 나쁘지 않은 성능으로 페이징 하는데 문제가 없다 <a href="#user-content-fnref-1" aria-label="Back to reference 1" class="data-footnote-backref" data-footnote-backref><!--[-->↩<!--]--></a><!--]--></li><!--]--></ol><style>html pre.shiki code .szrzo, html code.shiki .szrzo{--shiki-default:#ADBAC7}html pre.shiki code .s3aqa, html code.shiki .s3aqa{--shiki-default:#F47067}html pre.shiki code .slGcm, html code.shiki .slGcm{--shiki-default:#DCBDFB}html pre.shiki code .sSMXU, html code.shiki .sSMXU{--shiki-default:#6CB6FF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html pre.shiki code .skFXu, html code.shiki .skFXu{--shiki-default:#F69D50}html pre.shiki code .s6sc0, html code.shiki .s6sc0{--shiki-default:#96D0FF}html pre.shiki code .sca0q, html code.shiki .sca0q{--shiki-default:#768390}</style></div></div></article><!--]--><footer><div class="container"> CopyRight © 2022 Changkyun Kim </div></footer></div></div><div id="teleports"></div><script type="application/json" data-nuxt-data="nuxt-app" data-ssr="true" id="__NUXT_DATA__">[["ShallowReactive",1],{"prerenderedAt":2,"data":3,"state":2444,"once":2446,"_errors":2447,"serverRendered":223,"path":2436},1742875105446,["ShallowReactive",4],{"$gA87qiXR3y":5},{"id":6,"title":7,"body":8,"coverImage":2430,"createdAt":2431,"description":2432,"extension":2433,"meta":2434,"navigation":223,"path":2436,"seo":2437,"stem":2439,"tags":2440},"blog/blog/2020-06/20-mongodb-performance-on-paging.md","몽고디비 페이징과 룩업 성능",{"type":9,"value":10,"toc":2424},"minimal",[11,15,18,30,33,140,145,167,186,189,735,745,748,755,887,890,907,920,929,935,1099,1119,1124,1128,1137,1140,1146,1725,1729,1737,1743,1754,2275,2278,2384,2390,2393,2402,2406,2420],[12,13,14],"p",{},"몽고디비는 도큐먼트DB 특성상 기존 RDBMS와는 데이터를 다루는 철학에 차이가 조금 있다.",[12,16,17],{},"이번에 회사 프로덕트를 만들면서 여러 컬렉션을 참조하는 목록을 페이징하는 쿠에리에서 심각하게 성능저하가 일어나는 것을 발견하여 이를 해결하는 과정을 소개한다.",[12,19,20,21,25,26,29],{},"우선, 페이징을 구현하기 위해서는 전체 컬렉션 또는 커서의 일부분만 잘라내어 fetch 해줄 방법이 필요하다. 몽고디비에는 ",[22,23,24],"code",{},".skip()"," 과 ",[22,27,28],{},".limit()"," 체인메소드를 기본 제공하기 때문에 이 부분에는 문제가 없다.",[12,31,32],{},"하지만 총 몇 page가 존재하는지(또는 이전/다음 페이지가 존재하는지)를 알기 위해서는 커서의 총 도큐먼트 수를 알아내야 할 필요가 있다. 과거 3.x 이전 버전에서는 우선 cursor를 만든다음 클론하여 하나는 도큐먼트 수를 세는데, 하나는 커서의 일부를 잘라내는데 사용했었다.",[34,35,40],"pre",{"className":36,"code":37,"language":38,"meta":39,"style":39},"language-js shiki shiki-themes github-dark-dimmed","mongo> var cursor = db.contents.find(query)\nmongo> var total = cursor.clone().count()\nmongo> cursor.skip((page - 1) * itemPerPage).limit(itemPerPage)\n","js","",[22,41,42,74,103],{"__ignoreMap":39},[43,44,47,51,55,58,61,64,67,71],"span",{"class":45,"line":46},"line",1,[43,48,50],{"class":49},"szrzo","mongo",[43,52,54],{"class":53},"s3aqa",">",[43,56,57],{"class":53}," var",[43,59,60],{"class":49}," cursor ",[43,62,63],{"class":53},"=",[43,65,66],{"class":49}," db.contents.",[43,68,70],{"class":69},"slGcm","find",[43,72,73],{"class":49},"(query)\n",[43,75,77,79,81,83,86,88,91,94,97,100],{"class":45,"line":76},2,[43,78,50],{"class":49},[43,80,54],{"class":53},[43,82,57],{"class":53},[43,84,85],{"class":49}," total ",[43,87,63],{"class":53},[43,89,90],{"class":49}," cursor.",[43,92,93],{"class":69},"clone",[43,95,96],{"class":49},"().",[43,98,99],{"class":69},"count",[43,101,102],{"class":49},"()\n",[43,104,106,108,110,112,115,118,121,125,128,131,134,137],{"class":45,"line":105},3,[43,107,50],{"class":49},[43,109,54],{"class":53},[43,111,90],{"class":49},[43,113,114],{"class":69},"skip",[43,116,117],{"class":49},"((page ",[43,119,120],{"class":53},"-",[43,122,124],{"class":123},"sSMXU"," 1",[43,126,127],{"class":49},") ",[43,129,130],{"class":53},"*",[43,132,133],{"class":49}," itemPerPage).",[43,135,136],{"class":69},"limit",[43,138,139],{"class":49},"(itemPerPage)\n",[141,142,144],"h2",{"id":143},"페이징할-문서-전체의-갯수-가져오기","페이징할 문서 전체의 갯수 가져오기",[12,146,147,148,151,152,155,156,159,160,162,163,166],{},"4.x 부터는 ",[22,149,150],{},"cursor.count()"," 메소드 사용을 지양하고 ",[22,153,154],{},"collection.countDocuments(query)"," 또는 ",[22,157,158],{},"collection.estimatedDocumentCount(query)"," 를 대신 사용할 것을 권장할 뿐 아니라, 일부 드라이버에서는 이미 ",[22,161,150],{}," 메소드가 deprecate 되어있다. 여기에는 함정이 숨어있는데, 단순 ",[22,164,165],{},"collection.find()","가 아닌 aggregation의 경우에는 해당되지 않는다는 점이다.",[12,168,169,170,173,174,177,178,181,182,185],{},"aggregation을 페이징 하려면 ",[22,171,172],{},"AggregationPipeline.count()"," 를 조회하는 대신 pipeline의 일정 단계 이후 스테이지를 분기하여 각각 ",[22,175,176],{},"도큐먼트 수"," 및 ",[22,179,180],{},"페이징된 커서"," 를 얻는데 사용해야 한다. 스테이지를 여러개로 분리하는데는 ",[22,183,184],{},"$facet"," 스테이지를 활용하면 한번의 오퍼레이션으로 두가지 정보를 한꺼번에 가져올 수 있다.",[12,187,188],{},"(여기서부터는 헬퍼 코드를 작성했기 때문에, mongo shell 대신 각종 언어 드라이버 기준으로...)",[34,190,194],{"className":191,"code":192,"language":193,"meta":39,"style":39},"language-python shiki shiki-themes github-dark-dimmed","@dataclass\nclass PagedAggregation(object):\n\n    page: int = 1\n    page_size: int = 10\n    total: int = 0\n    items: List[dict] = field(default_factory=list)\n\n    def __iter__(self) -> Generator[dict]:\n        yield from self.items\n\n    def __json__(self) -> dict:\n        return {\n            'page': self.page,\n            'pageSize': self.page_size,\n            'total': self.total,\n            'totalPages': math.ceil(self.total / self.page_size),\n            'items': self.items\n        }\n\ndef paged(collection: Collection, pipeline: List=[], page=1, page_size=10) -> PagedAggregation:\n    \"\"\"\n    generates an aggregation facet pipeline, then fetch\n    \"\"\"\n    pager = {'$facet': {\n        'metadata': [\n            {'$count': 'total'},\n            {'$addFields': {'page': page}}\n        ],\n        'items': [\n            {'$skip': (page - 1) * page_size},\n            {'$limit': page_size}\n        ]\n    }}\n\n    paged_pipeline = pipeline[:]\n    paged_pipeline.append(pager)\n    doc = next(collection.aggregate(paged_pipeline))\n\n    return PagedAggregation(\n        page=page,\n        page_size=page_size,\n        total=doc['metadata'][0]['total'],\n        items=doc['items']\n    )\n","python",[22,195,196,201,219,225,240,253,266,294,299,316,328,333,349,358,374,387,400,422,434,440,445,478,484,490,495,512,521,538,555,561,569,591,602,608,614,619,630,636,650,655,664,675,686,713,729],{"__ignoreMap":39},[43,197,198],{"class":45,"line":46},[43,199,200],{"class":69},"@dataclass\n",[43,202,203,206,210,213,216],{"class":45,"line":76},[43,204,205],{"class":53},"class",[43,207,209],{"class":208},"skFXu"," PagedAggregation",[43,211,212],{"class":49},"(",[43,214,215],{"class":123},"object",[43,217,218],{"class":49},"):\n",[43,220,221],{"class":45,"line":105},[43,222,224],{"emptyLinePlaceholder":223},true,"\n",[43,226,228,231,234,237],{"class":45,"line":227},4,[43,229,230],{"class":49},"    page: ",[43,232,233],{"class":123},"int",[43,235,236],{"class":53}," =",[43,238,239],{"class":123}," 1\n",[43,241,243,246,248,250],{"class":45,"line":242},5,[43,244,245],{"class":49},"    page_size: ",[43,247,233],{"class":123},[43,249,236],{"class":53},[43,251,252],{"class":123}," 10\n",[43,254,256,259,261,263],{"class":45,"line":255},6,[43,257,258],{"class":49},"    total: ",[43,260,233],{"class":123},[43,262,236],{"class":53},[43,264,265],{"class":123}," 0\n",[43,267,269,272,275,278,280,283,286,288,291],{"class":45,"line":268},7,[43,270,271],{"class":49},"    items: List[",[43,273,274],{"class":123},"dict",[43,276,277],{"class":49},"] ",[43,279,63],{"class":53},[43,281,282],{"class":49}," field(",[43,284,285],{"class":208},"default_factory",[43,287,63],{"class":53},[43,289,290],{"class":123},"list",[43,292,293],{"class":49},")\n",[43,295,297],{"class":45,"line":296},8,[43,298,224],{"emptyLinePlaceholder":223},[43,300,302,305,308,311,313],{"class":45,"line":301},9,[43,303,304],{"class":53},"    def",[43,306,307],{"class":123}," __iter__",[43,309,310],{"class":49},"(self) -> Generator[",[43,312,274],{"class":123},[43,314,315],{"class":49},"]:\n",[43,317,319,322,325],{"class":45,"line":318},10,[43,320,321],{"class":53},"        yield from",[43,323,324],{"class":123}," self",[43,326,327],{"class":49},".items\n",[43,329,331],{"class":45,"line":330},11,[43,332,224],{"emptyLinePlaceholder":223},[43,334,336,338,341,344,346],{"class":45,"line":335},12,[43,337,304],{"class":53},[43,339,340],{"class":69}," __json__",[43,342,343],{"class":49},"(self) -> ",[43,345,274],{"class":123},[43,347,348],{"class":49},":\n",[43,350,352,355],{"class":45,"line":351},13,[43,353,354],{"class":53},"        return",[43,356,357],{"class":49}," {\n",[43,359,361,365,368,371],{"class":45,"line":360},14,[43,362,364],{"class":363},"s6sc0","            'page'",[43,366,367],{"class":49},": ",[43,369,370],{"class":123},"self",[43,372,373],{"class":49},".page,\n",[43,375,377,380,382,384],{"class":45,"line":376},15,[43,378,379],{"class":363},"            'pageSize'",[43,381,367],{"class":49},[43,383,370],{"class":123},[43,385,386],{"class":49},".page_size,\n",[43,388,390,393,395,397],{"class":45,"line":389},16,[43,391,392],{"class":363},"            'total'",[43,394,367],{"class":49},[43,396,370],{"class":123},[43,398,399],{"class":49},".total,\n",[43,401,403,406,409,411,414,417,419],{"class":45,"line":402},17,[43,404,405],{"class":363},"            'totalPages'",[43,407,408],{"class":49},": math.ceil(",[43,410,370],{"class":123},[43,412,413],{"class":49},".total ",[43,415,416],{"class":53},"/",[43,418,324],{"class":123},[43,420,421],{"class":49},".page_size),\n",[43,423,425,428,430,432],{"class":45,"line":424},18,[43,426,427],{"class":363},"            'items'",[43,429,367],{"class":49},[43,431,370],{"class":123},[43,433,327],{"class":49},[43,435,437],{"class":45,"line":436},19,[43,438,439],{"class":49},"        }\n",[43,441,443],{"class":45,"line":442},20,[43,444,224],{"emptyLinePlaceholder":223},[43,446,448,451,454,457,459,462,464,467,470,472,475],{"class":45,"line":447},21,[43,449,450],{"class":53},"def",[43,452,453],{"class":69}," paged",[43,455,456],{"class":49},"(collection: Collection, pipeline: List",[43,458,63],{"class":53},[43,460,461],{"class":49},"[], page",[43,463,63],{"class":53},[43,465,466],{"class":123},"1",[43,468,469],{"class":49},", page_size",[43,471,63],{"class":53},[43,473,474],{"class":123},"10",[43,476,477],{"class":49},") -> PagedAggregation:\n",[43,479,481],{"class":45,"line":480},22,[43,482,483],{"class":363},"    \"\"\"\n",[43,485,487],{"class":45,"line":486},23,[43,488,489],{"class":363},"    generates an aggregation facet pipeline, then fetch\n",[43,491,493],{"class":45,"line":492},24,[43,494,483],{"class":363},[43,496,498,501,503,506,509],{"class":45,"line":497},25,[43,499,500],{"class":49},"    pager ",[43,502,63],{"class":53},[43,504,505],{"class":49}," {",[43,507,508],{"class":363},"'$facet'",[43,510,511],{"class":49},": {\n",[43,513,515,518],{"class":45,"line":514},26,[43,516,517],{"class":363},"        'metadata'",[43,519,520],{"class":49},": [\n",[43,522,524,527,530,532,535],{"class":45,"line":523},27,[43,525,526],{"class":49},"            {",[43,528,529],{"class":363},"'$count'",[43,531,367],{"class":49},[43,533,534],{"class":363},"'total'",[43,536,537],{"class":49},"},\n",[43,539,541,543,546,549,552],{"class":45,"line":540},28,[43,542,526],{"class":49},[43,544,545],{"class":363},"'$addFields'",[43,547,548],{"class":49},": {",[43,550,551],{"class":363},"'page'",[43,553,554],{"class":49},": page}}\n",[43,556,558],{"class":45,"line":557},29,[43,559,560],{"class":49},"        ],\n",[43,562,564,567],{"class":45,"line":563},30,[43,565,566],{"class":363},"        'items'",[43,568,520],{"class":49},[43,570,572,574,577,580,582,584,586,588],{"class":45,"line":571},31,[43,573,526],{"class":49},[43,575,576],{"class":363},"'$skip'",[43,578,579],{"class":49},": (page ",[43,581,120],{"class":53},[43,583,124],{"class":123},[43,585,127],{"class":49},[43,587,130],{"class":53},[43,589,590],{"class":49}," page_size},\n",[43,592,594,596,599],{"class":45,"line":593},32,[43,595,526],{"class":49},[43,597,598],{"class":363},"'$limit'",[43,600,601],{"class":49},": page_size}\n",[43,603,605],{"class":45,"line":604},33,[43,606,607],{"class":49},"        ]\n",[43,609,611],{"class":45,"line":610},34,[43,612,613],{"class":49},"    }}\n",[43,615,617],{"class":45,"line":616},35,[43,618,224],{"emptyLinePlaceholder":223},[43,620,622,625,627],{"class":45,"line":621},36,[43,623,624],{"class":49},"    paged_pipeline ",[43,626,63],{"class":53},[43,628,629],{"class":49}," pipeline[:]\n",[43,631,633],{"class":45,"line":632},37,[43,634,635],{"class":49},"    paged_pipeline.append(pager)\n",[43,637,639,642,644,647],{"class":45,"line":638},38,[43,640,641],{"class":49},"    doc ",[43,643,63],{"class":53},[43,645,646],{"class":123}," next",[43,648,649],{"class":49},"(collection.aggregate(paged_pipeline))\n",[43,651,653],{"class":45,"line":652},39,[43,654,224],{"emptyLinePlaceholder":223},[43,656,658,661],{"class":45,"line":657},40,[43,659,660],{"class":53},"    return",[43,662,663],{"class":49}," PagedAggregation(\n",[43,665,667,670,672],{"class":45,"line":666},41,[43,668,669],{"class":208},"        page",[43,671,63],{"class":53},[43,673,674],{"class":49},"page,\n",[43,676,678,681,683],{"class":45,"line":677},42,[43,679,680],{"class":208},"        page_size",[43,682,63],{"class":53},[43,684,685],{"class":49},"page_size,\n",[43,687,689,692,694,697,700,703,706,708,710],{"class":45,"line":688},43,[43,690,691],{"class":208},"        total",[43,693,63],{"class":53},[43,695,696],{"class":49},"doc[",[43,698,699],{"class":363},"'metadata'",[43,701,702],{"class":49},"][",[43,704,705],{"class":123},"0",[43,707,702],{"class":49},[43,709,534],{"class":363},[43,711,712],{"class":49},"],\n",[43,714,716,719,721,723,726],{"class":45,"line":715},44,[43,717,718],{"class":208},"        items",[43,720,63],{"class":53},[43,722,696],{"class":49},[43,724,725],{"class":363},"'items'",[43,727,728],{"class":49},"]\n",[43,730,732],{"class":45,"line":731},45,[43,733,734],{"class":49},"    )\n",[12,736,737,738,744],{},"구글링과 스택넘침질로 얻은 각종 스킬들을 조합하여 나름 꽤 심플하고 합리적으로 aggregate의 페이징을 정리한 듯 했다",[739,740,466],"a",{"href":741,"aria-described-by":742,"dataFootnoteRef":39,"id":743},"#user-content-fn-1","footnote-label","user-content-fnref-1",". 하지만 문서 수가 수십만을 넘기 시작하면서, 파이프라인에서 다른 컬렉션을 $lookup 하는 빈도가 늘어나면서 성능이 심각할 정도로 나빠지기 시작했다.",[12,746,747],{},"개인적으로는 실행 계획(explain)을 눈으로 짐작하기 쉽지 않은 SQL보다 각 단계에서 할 일을 순차적으로 명시하는 aggregation pipeline 쪽이 훨씬 낫다고 생각했었다. 물론 그 사실에는 변함이 없지만, 데이터를 \"관계\"로 바라보는 RDBMS와 다르게 \"도큐먼트\"로 바라보는 몽고디비의 철학에서 내가 원하는 \"결과\"만을 목적으로 파이프라인을 짜다보면 자신이 놓은 함정에 걸리게 되는 경우가 생긴다.",[12,749,750,751,754],{},"위에 작성한 ",[22,752,753],{},"paged"," 헬퍼를 이용하여 평균 20여개의 코멘트가 달린 100만건의 블로그 글 목록에서 내가 작성한 글의 일부 페이지를 가져오려고 한다면,",[34,756,758],{"className":191,"code":757,"language":193,"meta":39,"style":39},"pipeline = [\n  {'$match': {\n    'author_id': me\n  }},\n  {'$lookup': {\n    'from': 'comments',\n    'localField': '_id',\n    'foreignField': 'article_id',\n    'as': 'comments'\n  }}\n]\n\npaged(db.articles, pipeline, page=100, page_size=10)\n",[22,759,760,770,780,788,793,802,815,827,839,849,854,858,862],{"__ignoreMap":39},[43,761,762,765,767],{"class":45,"line":46},[43,763,764],{"class":49},"pipeline ",[43,766,63],{"class":53},[43,768,769],{"class":49}," [\n",[43,771,772,775,778],{"class":45,"line":76},[43,773,774],{"class":49},"  {",[43,776,777],{"class":363},"'$match'",[43,779,511],{"class":49},[43,781,782,785],{"class":45,"line":105},[43,783,784],{"class":363},"    'author_id'",[43,786,787],{"class":49},": me\n",[43,789,790],{"class":45,"line":227},[43,791,792],{"class":49},"  }},\n",[43,794,795,797,800],{"class":45,"line":242},[43,796,774],{"class":49},[43,798,799],{"class":363},"'$lookup'",[43,801,511],{"class":49},[43,803,804,807,809,812],{"class":45,"line":255},[43,805,806],{"class":363},"    'from'",[43,808,367],{"class":49},[43,810,811],{"class":363},"'comments'",[43,813,814],{"class":49},",\n",[43,816,817,820,822,825],{"class":45,"line":268},[43,818,819],{"class":363},"    'localField'",[43,821,367],{"class":49},[43,823,824],{"class":363},"'_id'",[43,826,814],{"class":49},[43,828,829,832,834,837],{"class":45,"line":296},[43,830,831],{"class":363},"    'foreignField'",[43,833,367],{"class":49},[43,835,836],{"class":363},"'article_id'",[43,838,814],{"class":49},[43,840,841,844,846],{"class":45,"line":301},[43,842,843],{"class":363},"    'as'",[43,845,367],{"class":49},[43,847,848],{"class":363},"'comments'\n",[43,850,851],{"class":45,"line":318},[43,852,853],{"class":49},"  }}\n",[43,855,856],{"class":45,"line":330},[43,857,728],{"class":49},[43,859,860],{"class":45,"line":335},[43,861,224],{"emptyLinePlaceholder":223},[43,863,864,867,870,872,875,878,881,883,885],{"class":45,"line":351},[43,865,866],{"class":49},"paged(db.articles, pipeline, ",[43,868,869],{"class":208},"page",[43,871,63],{"class":53},[43,873,874],{"class":123},"100",[43,876,877],{"class":49},", ",[43,879,880],{"class":208},"page_size",[43,882,63],{"class":53},[43,884,474],{"class":123},[43,886,293],{"class":49},[12,888,889],{},"이런 식이 될 것이다.",[12,891,892,895,896,877,899,902,903,906],{},[22,893,894],{},"$lookup"," 스테이지가 ",[22,897,898],{},"$skip",[22,900,901],{},"$limit"," 스테이지보다 앞서 등장하기 때문에 10개의 도큐먼트를 얻기 전에 100만건 article 모두에 대한 comment 를 미리 lookup 하게 되어, 사실상 문서마다 20개의 댓글을 포함하여 총 2000만개의 도큐먼트를 조회한 후 그중 일부를 가져오게 된다. aggregation pipeline은 메모리상에서 최대 100MB만 사용할 수 있는 제약사항이 있기 때문에 스테이지의 일부 단계에서 문서 갯수가 많거나 메모리를 초과할 것으로 예상된다면 미리 ",[22,904,905],{},"allowDiskUse"," 옵션을 활성화 시켜 두지 않았다면 최종 10개 문서(x20개 댓글)를 가져오기 전에 이미 메모리 부족 에러를 만날 가능성도 있다.",[12,908,909,910,913,914,916,917,919],{},"위 예시의 경우는 페이징을 마치 RDBMS의 ",[22,911,912],{},"LIMIT n, m"," 으로 다루듯 마지막 단계에만 페이징을 위한 스테이지를 추가하는 경우를 보여주는 예시로, 몽고디비에서 쉽게 저지를 수 있는 실수에 해당한다. ",[22,915,894],{}," 스테이지를 직접 ",[22,918,901],{}," 스테이지 다음으로 옮겨두면 극적으로 성능 향상을 기대할 수 있다.",[12,921,922,924,925,928],{},[22,923,894],{},"된 외래 도큐먼트의 속성을 ",[22,926,927],{},"$match"," 스테이지에서 활용하고자 하는 경우엔 이야기가 달라진다.",[930,931,932],"blockquote",{},[12,933,934],{},"19세 미만 미성년자가 작성한 글과 댓글을 가져오려는 경우..",[34,936,938],{"className":191,"code":937,"language":193,"meta":39,"style":39},"pipeline = [\n  {'$lookup': {\n    'from': 'author',\n    'localField': 'author_id',\n    'foreignField': '_id',\n    'as': 'author'\n  }},\n  {'$unwind': '$author'},\n  {'$match': {\n    'author.age': {'$lte': 19}\n  }},\n  {'$lookup': {\n    'from': 'comments',\n    'localField': '_id',\n    'foreignField': 'article_id',\n    'as': 'comments'\n  }}\n]\n",[22,939,940,948,956,967,978,988,997,1001,1015,1023,1041,1045,1053,1063,1073,1083,1091,1095],{"__ignoreMap":39},[43,941,942,944,946],{"class":45,"line":46},[43,943,764],{"class":49},[43,945,63],{"class":53},[43,947,769],{"class":49},[43,949,950,952,954],{"class":45,"line":76},[43,951,774],{"class":49},[43,953,799],{"class":363},[43,955,511],{"class":49},[43,957,958,960,962,965],{"class":45,"line":105},[43,959,806],{"class":363},[43,961,367],{"class":49},[43,963,964],{"class":363},"'author'",[43,966,814],{"class":49},[43,968,969,971,973,976],{"class":45,"line":227},[43,970,819],{"class":363},[43,972,367],{"class":49},[43,974,975],{"class":363},"'author_id'",[43,977,814],{"class":49},[43,979,980,982,984,986],{"class":45,"line":242},[43,981,831],{"class":363},[43,983,367],{"class":49},[43,985,824],{"class":363},[43,987,814],{"class":49},[43,989,990,992,994],{"class":45,"line":255},[43,991,843],{"class":363},[43,993,367],{"class":49},[43,995,996],{"class":363},"'author'\n",[43,998,999],{"class":45,"line":268},[43,1000,792],{"class":49},[43,1002,1003,1005,1008,1010,1013],{"class":45,"line":296},[43,1004,774],{"class":49},[43,1006,1007],{"class":363},"'$unwind'",[43,1009,367],{"class":49},[43,1011,1012],{"class":363},"'$author'",[43,1014,537],{"class":49},[43,1016,1017,1019,1021],{"class":45,"line":301},[43,1018,774],{"class":49},[43,1020,777],{"class":363},[43,1022,511],{"class":49},[43,1024,1025,1028,1030,1033,1035,1038],{"class":45,"line":318},[43,1026,1027],{"class":363},"    'author.age'",[43,1029,548],{"class":49},[43,1031,1032],{"class":363},"'$lte'",[43,1034,367],{"class":49},[43,1036,1037],{"class":123},"19",[43,1039,1040],{"class":49},"}\n",[43,1042,1043],{"class":45,"line":330},[43,1044,792],{"class":49},[43,1046,1047,1049,1051],{"class":45,"line":335},[43,1048,774],{"class":49},[43,1050,799],{"class":363},[43,1052,511],{"class":49},[43,1054,1055,1057,1059,1061],{"class":45,"line":351},[43,1056,806],{"class":363},[43,1058,367],{"class":49},[43,1060,811],{"class":363},[43,1062,814],{"class":49},[43,1064,1065,1067,1069,1071],{"class":45,"line":360},[43,1066,819],{"class":363},[43,1068,367],{"class":49},[43,1070,824],{"class":363},[43,1072,814],{"class":49},[43,1074,1075,1077,1079,1081],{"class":45,"line":376},[43,1076,831],{"class":363},[43,1078,367],{"class":49},[43,1080,836],{"class":363},[43,1082,814],{"class":49},[43,1084,1085,1087,1089],{"class":45,"line":389},[43,1086,843],{"class":363},[43,1088,367],{"class":49},[43,1090,848],{"class":363},[43,1092,1093],{"class":45,"line":402},[43,1094,853],{"class":49},[43,1096,1097],{"class":45,"line":424},[43,1098,728],{"class":49},[12,1100,1101,1102,1104,1105,1108,1109,1111,1112,1114,1115,1118],{},"이런 경우는 3번째에 등장하는 ",[22,1103,927],{}," 스테이지에서 ",[22,1106,1107],{},"author.age","를 조건으로 사용하기 위해 미리 ",[22,1110,894],{}," 하지 않을 수 없기 때문에 ",[22,1113,894],{},"의 순서를 뒤로 미뤄 성능 향상을 기대할 수는 없다. RDBMS에서는 자주 등장할 수 있는 쿠에리지만 ",[22,1116,1117],{},"JOIN","되는 필드에 외래키, 인덱스가 적절히 걸려있다면 심각한 성능 저하가 발생하지는 않는다.",[12,1120,1121,1123],{},[22,1122,894],{},"을 최적화 하는 과정은 아직도 진행단계고 좀 긴 넋두리가 필요하므로 다음기회(가 있다면)에 소개하기로 한다.",[141,1125,1127],{"id":1126},"facet-퍼포먼스-문제","$facet 퍼포먼스 문제",[12,1129,1130,1131,1133,1134,1136],{},"두번째로 발견한 성능저하의 문제는, ",[22,1132,184],{},"의 퍼포먼스가 너무 좋지 않다. 하나의 pipeline을 둘로 나누어 병렬로 실행한다 라는 아이디어는 깜찍하고 좋았지만, 실제 실행 단계에서 나뉘기 전 스테이지까지의 결과를 재활용하기는 하는건지 의심스러울 정도로 ",[22,1135,184],{},"가 등장하는 aggregation은 성능이 항상 좋지 않았다.",[12,1138,1139],{},"또한, 문서 수 및 문서 목록을 하나의 파이프라인에서 모두 연산해 올 때 까지 대기해야 하므로 replicaSet의 분산 처리 도움을 별로 받지 못한다.",[12,1141,1142,1143,1145],{},"nodejs 에서는 mongoos 라이브러리의 구현을 조금 참조하여 ",[22,1144,184],{},"를 쓰지 않고 두번에 나누어 (동시에)실행하도록 paged 헬퍼를 수정했다.",[34,1147,1149],{"className":36,"code":1148,"language":38,"meta":39,"style":39},"/**\n * 몽고디비 aggregation 을 페이징한다\n * @async\n * @param {Collection} collection 몽고디비 컬렉션\n * @param {object | object[]} condition query 또는 aggregation 파이프라인\n * @param {object} [options]\n * @param {number} [options.page = 1] 페이지번호\n * @param {number} [options.pageSize = 10] 페이지당 문서 갯수\n * @returns {Promise\u003CPagedCursor>}\n */\nexport const paged = (\n  collection,\n  condition,\n  { page = 1, pageSize = 10 } = {}\n) => {\n  let pipeline = [];\n  if (Array.isArray(condition)) {\n    // aggregation pipeline인 경우\n    pipeline.push.apply(pipeline, condition);\n  } else {\n    // query only인 경우\n    pipeline.push({ $match: condition });\n  }\n\n  const countPipeline = [...pipeline].filter((elm) => !elm[\"$sort\"]);\n  countPipeline.push({ $group: { _id: null, count: { $sum: 1 } } });\n\n  const pagedPipeline = [...pipeline];\n  pagedPipeline.push({ $skip: (page - 1) * pageSize });\n  pagedPipeline.push({ $limit: pageSize });\n\n  return Promise.all([\n    collection.aggregate(pagedPipeline, { allowDiskUse: true }).toArray(),\n    collection.aggregate(countPipeline, { allowDiskUse: true }).toArray(),\n  ]).then(([items, countResult]) => {\n    const total = countResult.length > 0 ? countResult.shift().count : 0;\n    const totalPages = Math.ceil(total / pageSize);\n    return {\n      page,\n      pageSize,\n      total,\n      totalPages,\n      items,\n    };\n  });\n};\n",[22,1150,1151,1157,1162,1170,1186,1201,1213,1233,1252,1262,1267,1282,1289,1296,1325,1334,1347,1361,1366,1377,1387,1392,1403,1408,1412,1456,1477,1481,1497,1518,1527,1531,1548,1571,1588,1614,1655,1678,1684,1689,1694,1699,1704,1709,1714,1719],{"__ignoreMap":39},[43,1152,1153],{"class":45,"line":46},[43,1154,1156],{"class":1155},"sca0q","/**\n",[43,1158,1159],{"class":45,"line":76},[43,1160,1161],{"class":1155}," * 몽고디비 aggregation 을 페이징한다\n",[43,1163,1164,1167],{"class":45,"line":105},[43,1165,1166],{"class":1155}," * ",[43,1168,1169],{"class":53},"@async\n",[43,1171,1172,1174,1177,1180,1183],{"class":45,"line":227},[43,1173,1166],{"class":1155},[43,1175,1176],{"class":53},"@param",[43,1178,1179],{"class":208}," {Collection}",[43,1181,1182],{"class":49}," collection",[43,1184,1185],{"class":1155}," 몽고디비 컬렉션\n",[43,1187,1188,1190,1192,1195,1198],{"class":45,"line":242},[43,1189,1166],{"class":1155},[43,1191,1176],{"class":53},[43,1193,1194],{"class":208}," {object | object[]}",[43,1196,1197],{"class":49}," condition",[43,1199,1200],{"class":1155}," query 또는 aggregation 파이프라인\n",[43,1202,1203,1205,1207,1210],{"class":45,"line":255},[43,1204,1166],{"class":1155},[43,1206,1176],{"class":53},[43,1208,1209],{"class":208}," {object}",[43,1211,1212],{"class":49}," [options]\n",[43,1214,1215,1217,1219,1222,1225,1227,1230],{"class":45,"line":268},[43,1216,1166],{"class":1155},[43,1218,1176],{"class":53},[43,1220,1221],{"class":208}," {number}",[43,1223,1224],{"class":49}," [options.page ",[43,1226,63],{"class":53},[43,1228,1229],{"class":49}," 1]",[43,1231,1232],{"class":1155}," 페이지번호\n",[43,1234,1235,1237,1239,1241,1244,1246,1249],{"class":45,"line":296},[43,1236,1166],{"class":1155},[43,1238,1176],{"class":53},[43,1240,1221],{"class":208},[43,1242,1243],{"class":49}," [options.pageSize ",[43,1245,63],{"class":53},[43,1247,1248],{"class":49}," 10]",[43,1250,1251],{"class":1155}," 페이지당 문서 갯수\n",[43,1253,1254,1256,1259],{"class":45,"line":301},[43,1255,1166],{"class":1155},[43,1257,1258],{"class":53},"@returns",[43,1260,1261],{"class":208}," {Promise\u003CPagedCursor>}\n",[43,1263,1264],{"class":45,"line":318},[43,1265,1266],{"class":1155}," */\n",[43,1268,1269,1272,1275,1277,1279],{"class":45,"line":330},[43,1270,1271],{"class":53},"export",[43,1273,1274],{"class":53}," const",[43,1276,453],{"class":69},[43,1278,236],{"class":53},[43,1280,1281],{"class":49}," (\n",[43,1283,1284,1287],{"class":45,"line":335},[43,1285,1286],{"class":208},"  collection",[43,1288,814],{"class":49},[43,1290,1291,1294],{"class":45,"line":351},[43,1292,1293],{"class":208},"  condition",[43,1295,814],{"class":49},[43,1297,1298,1301,1303,1305,1307,1309,1312,1314,1317,1320,1322],{"class":45,"line":360},[43,1299,1300],{"class":49},"  { ",[43,1302,869],{"class":208},[43,1304,236],{"class":53},[43,1306,124],{"class":123},[43,1308,877],{"class":49},[43,1310,1311],{"class":208},"pageSize",[43,1313,236],{"class":53},[43,1315,1316],{"class":123}," 10",[43,1318,1319],{"class":49}," } ",[43,1321,63],{"class":53},[43,1323,1324],{"class":49}," {}\n",[43,1326,1327,1329,1332],{"class":45,"line":376},[43,1328,127],{"class":49},[43,1330,1331],{"class":53},"=>",[43,1333,357],{"class":49},[43,1335,1336,1339,1342,1344],{"class":45,"line":389},[43,1337,1338],{"class":53},"  let",[43,1340,1341],{"class":49}," pipeline ",[43,1343,63],{"class":53},[43,1345,1346],{"class":49}," [];\n",[43,1348,1349,1352,1355,1358],{"class":45,"line":402},[43,1350,1351],{"class":53},"  if",[43,1353,1354],{"class":49}," (Array.",[43,1356,1357],{"class":69},"isArray",[43,1359,1360],{"class":49},"(condition)) {\n",[43,1362,1363],{"class":45,"line":424},[43,1364,1365],{"class":1155},"    // aggregation pipeline인 경우\n",[43,1367,1368,1371,1374],{"class":45,"line":436},[43,1369,1370],{"class":49},"    pipeline.push.",[43,1372,1373],{"class":69},"apply",[43,1375,1376],{"class":49},"(pipeline, condition);\n",[43,1378,1379,1382,1385],{"class":45,"line":442},[43,1380,1381],{"class":49},"  } ",[43,1383,1384],{"class":53},"else",[43,1386,357],{"class":49},[43,1388,1389],{"class":45,"line":447},[43,1390,1391],{"class":1155},"    // query only인 경우\n",[43,1393,1394,1397,1400],{"class":45,"line":480},[43,1395,1396],{"class":49},"    pipeline.",[43,1398,1399],{"class":69},"push",[43,1401,1402],{"class":49},"({ $match: condition });\n",[43,1404,1405],{"class":45,"line":486},[43,1406,1407],{"class":49},"  }\n",[43,1409,1410],{"class":45,"line":492},[43,1411,224],{"emptyLinePlaceholder":223},[43,1413,1414,1417,1420,1422,1425,1428,1431,1434,1437,1440,1442,1444,1447,1450,1453],{"class":45,"line":497},[43,1415,1416],{"class":53},"  const",[43,1418,1419],{"class":123}," countPipeline",[43,1421,236],{"class":53},[43,1423,1424],{"class":49}," [",[43,1426,1427],{"class":53},"...",[43,1429,1430],{"class":49},"pipeline].",[43,1432,1433],{"class":69},"filter",[43,1435,1436],{"class":49},"((",[43,1438,1439],{"class":208},"elm",[43,1441,127],{"class":49},[43,1443,1331],{"class":53},[43,1445,1446],{"class":53}," !",[43,1448,1449],{"class":49},"elm[",[43,1451,1452],{"class":363},"\"$sort\"",[43,1454,1455],{"class":49},"]);\n",[43,1457,1458,1461,1463,1466,1469,1472,1474],{"class":45,"line":514},[43,1459,1460],{"class":49},"  countPipeline.",[43,1462,1399],{"class":69},[43,1464,1465],{"class":49},"({ $group: { _id: ",[43,1467,1468],{"class":123},"null",[43,1470,1471],{"class":49},", count: { $sum: ",[43,1473,466],{"class":123},[43,1475,1476],{"class":49}," } } });\n",[43,1478,1479],{"class":45,"line":523},[43,1480,224],{"emptyLinePlaceholder":223},[43,1482,1483,1485,1488,1490,1492,1494],{"class":45,"line":540},[43,1484,1416],{"class":53},[43,1486,1487],{"class":123}," pagedPipeline",[43,1489,236],{"class":53},[43,1491,1424],{"class":49},[43,1493,1427],{"class":53},[43,1495,1496],{"class":49},"pipeline];\n",[43,1498,1499,1502,1504,1507,1509,1511,1513,1515],{"class":45,"line":557},[43,1500,1501],{"class":49},"  pagedPipeline.",[43,1503,1399],{"class":69},[43,1505,1506],{"class":49},"({ $skip: (page ",[43,1508,120],{"class":53},[43,1510,124],{"class":123},[43,1512,127],{"class":49},[43,1514,130],{"class":53},[43,1516,1517],{"class":49}," pageSize });\n",[43,1519,1520,1522,1524],{"class":45,"line":563},[43,1521,1501],{"class":49},[43,1523,1399],{"class":69},[43,1525,1526],{"class":49},"({ $limit: pageSize });\n",[43,1528,1529],{"class":45,"line":571},[43,1530,224],{"emptyLinePlaceholder":223},[43,1532,1533,1536,1539,1542,1545],{"class":45,"line":593},[43,1534,1535],{"class":53},"  return",[43,1537,1538],{"class":123}," Promise",[43,1540,1541],{"class":49},".",[43,1543,1544],{"class":69},"all",[43,1546,1547],{"class":49},"([\n",[43,1549,1550,1553,1556,1559,1562,1565,1568],{"class":45,"line":604},[43,1551,1552],{"class":49},"    collection.",[43,1554,1555],{"class":69},"aggregate",[43,1557,1558],{"class":49},"(pagedPipeline, { allowDiskUse: ",[43,1560,1561],{"class":123},"true",[43,1563,1564],{"class":49}," }).",[43,1566,1567],{"class":69},"toArray",[43,1569,1570],{"class":49},"(),\n",[43,1572,1573,1575,1577,1580,1582,1584,1586],{"class":45,"line":610},[43,1574,1552],{"class":49},[43,1576,1555],{"class":69},[43,1578,1579],{"class":49},"(countPipeline, { allowDiskUse: ",[43,1581,1561],{"class":123},[43,1583,1564],{"class":49},[43,1585,1567],{"class":69},[43,1587,1570],{"class":49},[43,1589,1590,1593,1596,1599,1602,1604,1607,1610,1612],{"class":45,"line":616},[43,1591,1592],{"class":49},"  ]).",[43,1594,1595],{"class":69},"then",[43,1597,1598],{"class":49},"(([",[43,1600,1601],{"class":208},"items",[43,1603,877],{"class":49},[43,1605,1606],{"class":208},"countResult",[43,1608,1609],{"class":49},"]) ",[43,1611,1331],{"class":53},[43,1613,357],{"class":49},[43,1615,1616,1619,1622,1624,1627,1630,1633,1636,1639,1641,1644,1647,1650,1652],{"class":45,"line":621},[43,1617,1618],{"class":53},"    const",[43,1620,1621],{"class":123}," total",[43,1623,236],{"class":53},[43,1625,1626],{"class":49}," countResult.",[43,1628,1629],{"class":123},"length",[43,1631,1632],{"class":53}," >",[43,1634,1635],{"class":123}," 0",[43,1637,1638],{"class":53}," ?",[43,1640,1626],{"class":49},[43,1642,1643],{"class":69},"shift",[43,1645,1646],{"class":49},"().count ",[43,1648,1649],{"class":53},":",[43,1651,1635],{"class":123},[43,1653,1654],{"class":49},";\n",[43,1656,1657,1659,1662,1664,1667,1670,1673,1675],{"class":45,"line":632},[43,1658,1618],{"class":53},[43,1660,1661],{"class":123}," totalPages",[43,1663,236],{"class":53},[43,1665,1666],{"class":49}," Math.",[43,1668,1669],{"class":69},"ceil",[43,1671,1672],{"class":49},"(total ",[43,1674,416],{"class":53},[43,1676,1677],{"class":49}," pageSize);\n",[43,1679,1680,1682],{"class":45,"line":638},[43,1681,660],{"class":53},[43,1683,357],{"class":49},[43,1685,1686],{"class":45,"line":652},[43,1687,1688],{"class":49},"      page,\n",[43,1690,1691],{"class":45,"line":657},[43,1692,1693],{"class":49},"      pageSize,\n",[43,1695,1696],{"class":45,"line":666},[43,1697,1698],{"class":49},"      total,\n",[43,1700,1701],{"class":45,"line":677},[43,1702,1703],{"class":49},"      totalPages,\n",[43,1705,1706],{"class":45,"line":688},[43,1707,1708],{"class":49},"      items,\n",[43,1710,1711],{"class":45,"line":715},[43,1712,1713],{"class":49},"    };\n",[43,1715,1716],{"class":45,"line":731},[43,1717,1718],{"class":49},"  });\n",[43,1720,1722],{"class":45,"line":1721},46,[43,1723,1724],{"class":49},"};\n",[141,1726,1728],{"id":1727},"lazy-loading-전략","lazy loading 전략",[12,1730,1731,1733,1734,1736],{},[22,1732,894],{}," 스테이지의 목적이 단순히 다른 컬렉션의 일부 정보를 가져와 도큐먼트의 속성에 끼워넣어 주기를 바라기만 하는 경우라면 굳이 ",[22,1735,894],{}," 스테이지를 활용하지 않고, 연관 도큐먼트를 별도로 조회한 다음 결과 목록에 확장시켜주어도 성능엔 큰 차이가 없다. (orm 의 eager/lazy loading 전략과 비슷)",[12,1738,1739,1740,1742],{},"사실은 원시 컬렉션의 외래키를 수집하여 어플리케이션 서버에서 다시 두번째 쿠에리를 만들어 DB서버에 전송하는 것을 비효율적이지만, 어플리케이션 서버와 DB서버의 네트워크 거리가 충분히 가까운 경우라면 ",[22,1741,894],{}," 을 이용하여 몽고디비 내에서 연관 컬렉션을 조회하는 것과 거의 성능의 차이가 없고 어떤 경우는 더 좋은 경우도 있었다.",[12,1744,1745,1746,1749,1750,1753],{},"이런 역할을 하는 ",[22,1747,1748],{},"lookup()"," 헬퍼를 nodejs 버전으로 작성했다. 파라메터 종류는 ",[22,1751,1752],{},"$lookup($aggregation)"," 과 거의 같다.",[34,1755,1757],{"className":36,"code":1756,"language":38,"meta":39,"style":39},"/**\n * @param {DataBase} db\n * @param {object} information\n * @param {string} information.from 참조할 컬렉션 이름\n * @param {string} information.localField 외래키에 대응할 로컬 키 이름\n * @param {string} information.foreignField 왜래키 이름\n * @param {string} information.as 참조된 왜래 컬렉션의 아이템을 매핑할 속성명\n * @returns {lookup~filler}\n */\nexport const lookup = (db, {from, localField, foreignField, as, project = {}}) => {\n  /**\n   * @function lookup~filler\n   * @returns {PagedCursor}\n   */\n  return ({items, ...rest}) => {\n    const ids = items.map(item => item[localField])\n    return db.collection(from).find({\n      [foreignField]: {$in: ids}\n    }, {$project: project}).toArray().then(props => {\n      const propIds = props.map(prop => '' + prop[foreignField])\n      return {items: items.map(item => {\n        let index = propIds.indexOf('' + item[localField])\n        if (index > -1) {\n          item[as] = props[index]\n        }\n        return item\n      }), ...rest}\n    })\n  }\n}\n\n/**\n * 여러개의 lookup을 동시에 수행한다\n */\nexport const lookupAll = (db, ...desires) => {\n  return ({items, ...rest}) => Promise.all(desires.map(desire => lookup(db, desire)({items, ...rest})).then(([r]) => r)\n}\n",[22,1758,1759,1763,1775,1786,1801,1815,1829,1843,1852,1856,1908,1913,1924,1933,1938,1961,1987,2005,2010,2030,2061,2079,2104,2122,2132,2136,2143,2153,2158,2162,2166,2170,2174,2179,2183,2211,2271],{"__ignoreMap":39},[43,1760,1761],{"class":45,"line":46},[43,1762,1156],{"class":1155},[43,1764,1765,1767,1769,1772],{"class":45,"line":76},[43,1766,1166],{"class":1155},[43,1768,1176],{"class":53},[43,1770,1771],{"class":208}," {DataBase}",[43,1773,1774],{"class":49}," db\n",[43,1776,1777,1779,1781,1783],{"class":45,"line":105},[43,1778,1166],{"class":1155},[43,1780,1176],{"class":53},[43,1782,1209],{"class":208},[43,1784,1785],{"class":49}," information\n",[43,1787,1788,1790,1792,1795,1798],{"class":45,"line":227},[43,1789,1166],{"class":1155},[43,1791,1176],{"class":53},[43,1793,1794],{"class":208}," {string}",[43,1796,1797],{"class":49}," information.from",[43,1799,1800],{"class":1155}," 참조할 컬렉션 이름\n",[43,1802,1803,1805,1807,1809,1812],{"class":45,"line":242},[43,1804,1166],{"class":1155},[43,1806,1176],{"class":53},[43,1808,1794],{"class":208},[43,1810,1811],{"class":49}," information.localField",[43,1813,1814],{"class":1155}," 외래키에 대응할 로컬 키 이름\n",[43,1816,1817,1819,1821,1823,1826],{"class":45,"line":255},[43,1818,1166],{"class":1155},[43,1820,1176],{"class":53},[43,1822,1794],{"class":208},[43,1824,1825],{"class":49}," information.foreignField",[43,1827,1828],{"class":1155}," 왜래키 이름\n",[43,1830,1831,1833,1835,1837,1840],{"class":45,"line":268},[43,1832,1166],{"class":1155},[43,1834,1176],{"class":53},[43,1836,1794],{"class":208},[43,1838,1839],{"class":49}," information.as",[43,1841,1842],{"class":1155}," 참조된 왜래 컬렉션의 아이템을 매핑할 속성명\n",[43,1844,1845,1847,1849],{"class":45,"line":296},[43,1846,1166],{"class":1155},[43,1848,1258],{"class":53},[43,1850,1851],{"class":208}," {lookup~filler}\n",[43,1853,1854],{"class":45,"line":301},[43,1855,1266],{"class":1155},[43,1857,1858,1860,1862,1865,1867,1870,1873,1876,1879,1881,1884,1886,1889,1891,1894,1896,1899,1901,1904,1906],{"class":45,"line":318},[43,1859,1271],{"class":53},[43,1861,1274],{"class":53},[43,1863,1864],{"class":69}," lookup",[43,1866,236],{"class":53},[43,1868,1869],{"class":49}," (",[43,1871,1872],{"class":208},"db",[43,1874,1875],{"class":49},", {",[43,1877,1878],{"class":208},"from",[43,1880,877],{"class":49},[43,1882,1883],{"class":208},"localField",[43,1885,877],{"class":49},[43,1887,1888],{"class":208},"foreignField",[43,1890,877],{"class":49},[43,1892,1893],{"class":208},"as",[43,1895,877],{"class":49},[43,1897,1898],{"class":208},"project",[43,1900,236],{"class":53},[43,1902,1903],{"class":49}," {}}) ",[43,1905,1331],{"class":53},[43,1907,357],{"class":49},[43,1909,1910],{"class":45,"line":330},[43,1911,1912],{"class":1155},"  /**\n",[43,1914,1915,1918,1921],{"class":45,"line":335},[43,1916,1917],{"class":1155},"   * ",[43,1919,1920],{"class":53},"@function",[43,1922,1923],{"class":208}," lookup~filler\n",[43,1925,1926,1928,1930],{"class":45,"line":351},[43,1927,1917],{"class":1155},[43,1929,1258],{"class":53},[43,1931,1932],{"class":208}," {PagedCursor}\n",[43,1934,1935],{"class":45,"line":360},[43,1936,1937],{"class":1155},"   */\n",[43,1939,1940,1942,1945,1947,1949,1951,1954,1957,1959],{"class":45,"line":376},[43,1941,1535],{"class":53},[43,1943,1944],{"class":49}," ({",[43,1946,1601],{"class":208},[43,1948,877],{"class":49},[43,1950,1427],{"class":53},[43,1952,1953],{"class":208},"rest",[43,1955,1956],{"class":49},"}) ",[43,1958,1331],{"class":53},[43,1960,357],{"class":49},[43,1962,1963,1965,1968,1970,1973,1976,1978,1981,1984],{"class":45,"line":389},[43,1964,1618],{"class":53},[43,1966,1967],{"class":123}," ids",[43,1969,236],{"class":53},[43,1971,1972],{"class":49}," items.",[43,1974,1975],{"class":69},"map",[43,1977,212],{"class":49},[43,1979,1980],{"class":208},"item",[43,1982,1983],{"class":53}," =>",[43,1985,1986],{"class":49}," item[localField])\n",[43,1988,1989,1991,1994,1997,2000,2002],{"class":45,"line":402},[43,1990,660],{"class":53},[43,1992,1993],{"class":49}," db.",[43,1995,1996],{"class":69},"collection",[43,1998,1999],{"class":49},"(from).",[43,2001,70],{"class":69},[43,2003,2004],{"class":49},"({\n",[43,2006,2007],{"class":45,"line":424},[43,2008,2009],{"class":49},"      [foreignField]: {$in: ids}\n",[43,2011,2012,2015,2017,2019,2021,2023,2026,2028],{"class":45,"line":436},[43,2013,2014],{"class":49},"    }, {$project: project}).",[43,2016,1567],{"class":69},[43,2018,96],{"class":49},[43,2020,1595],{"class":69},[43,2022,212],{"class":49},[43,2024,2025],{"class":208},"props",[43,2027,1983],{"class":53},[43,2029,357],{"class":49},[43,2031,2032,2035,2038,2040,2043,2045,2047,2050,2052,2055,2058],{"class":45,"line":442},[43,2033,2034],{"class":53},"      const",[43,2036,2037],{"class":123}," propIds",[43,2039,236],{"class":53},[43,2041,2042],{"class":49}," props.",[43,2044,1975],{"class":69},[43,2046,212],{"class":49},[43,2048,2049],{"class":208},"prop",[43,2051,1983],{"class":53},[43,2053,2054],{"class":363}," ''",[43,2056,2057],{"class":53}," +",[43,2059,2060],{"class":49}," prop[foreignField])\n",[43,2062,2063,2066,2069,2071,2073,2075,2077],{"class":45,"line":447},[43,2064,2065],{"class":53},"      return",[43,2067,2068],{"class":49}," {items: items.",[43,2070,1975],{"class":69},[43,2072,212],{"class":49},[43,2074,1980],{"class":208},[43,2076,1983],{"class":53},[43,2078,357],{"class":49},[43,2080,2081,2084,2087,2089,2092,2095,2097,2100,2102],{"class":45,"line":480},[43,2082,2083],{"class":53},"        let",[43,2085,2086],{"class":49}," index ",[43,2088,63],{"class":53},[43,2090,2091],{"class":49}," propIds.",[43,2093,2094],{"class":69},"indexOf",[43,2096,212],{"class":49},[43,2098,2099],{"class":363},"''",[43,2101,2057],{"class":53},[43,2103,1986],{"class":49},[43,2105,2106,2109,2112,2114,2117,2119],{"class":45,"line":486},[43,2107,2108],{"class":53},"        if",[43,2110,2111],{"class":49}," (index ",[43,2113,54],{"class":53},[43,2115,2116],{"class":53}," -",[43,2118,466],{"class":123},[43,2120,2121],{"class":49},") {\n",[43,2123,2124,2127,2129],{"class":45,"line":492},[43,2125,2126],{"class":49},"          item[as] ",[43,2128,63],{"class":53},[43,2130,2131],{"class":49}," props[index]\n",[43,2133,2134],{"class":45,"line":497},[43,2135,439],{"class":49},[43,2137,2138,2140],{"class":45,"line":514},[43,2139,354],{"class":53},[43,2141,2142],{"class":49}," item\n",[43,2144,2145,2148,2150],{"class":45,"line":523},[43,2146,2147],{"class":49},"      }), ",[43,2149,1427],{"class":53},[43,2151,2152],{"class":49},"rest}\n",[43,2154,2155],{"class":45,"line":540},[43,2156,2157],{"class":49},"    })\n",[43,2159,2160],{"class":45,"line":557},[43,2161,1407],{"class":49},[43,2163,2164],{"class":45,"line":563},[43,2165,1040],{"class":49},[43,2167,2168],{"class":45,"line":571},[43,2169,224],{"emptyLinePlaceholder":223},[43,2171,2172],{"class":45,"line":593},[43,2173,1156],{"class":1155},[43,2175,2176],{"class":45,"line":604},[43,2177,2178],{"class":1155}," * 여러개의 lookup을 동시에 수행한다\n",[43,2180,2181],{"class":45,"line":610},[43,2182,1266],{"class":1155},[43,2184,2185,2187,2189,2192,2194,2196,2198,2200,2202,2205,2207,2209],{"class":45,"line":616},[43,2186,1271],{"class":53},[43,2188,1274],{"class":53},[43,2190,2191],{"class":69}," lookupAll",[43,2193,236],{"class":53},[43,2195,1869],{"class":49},[43,2197,1872],{"class":208},[43,2199,877],{"class":49},[43,2201,1427],{"class":53},[43,2203,2204],{"class":208},"desires",[43,2206,127],{"class":49},[43,2208,1331],{"class":53},[43,2210,357],{"class":49},[43,2212,2213,2215,2217,2219,2221,2223,2225,2227,2229,2231,2233,2235,2238,2240,2242,2245,2247,2249,2252,2254,2257,2259,2261,2264,2266,2268],{"class":45,"line":621},[43,2214,1535],{"class":53},[43,2216,1944],{"class":49},[43,2218,1601],{"class":208},[43,2220,877],{"class":49},[43,2222,1427],{"class":53},[43,2224,1953],{"class":208},[43,2226,1956],{"class":49},[43,2228,1331],{"class":53},[43,2230,1538],{"class":123},[43,2232,1541],{"class":49},[43,2234,1544],{"class":69},[43,2236,2237],{"class":49},"(desires.",[43,2239,1975],{"class":69},[43,2241,212],{"class":49},[43,2243,2244],{"class":208},"desire",[43,2246,1983],{"class":53},[43,2248,1864],{"class":69},[43,2250,2251],{"class":49},"(db, desire)({items, ",[43,2253,1427],{"class":53},[43,2255,2256],{"class":49},"rest})).",[43,2258,1595],{"class":69},[43,2260,1598],{"class":49},[43,2262,2263],{"class":208},"r",[43,2265,1609],{"class":49},[43,2267,1331],{"class":53},[43,2269,2270],{"class":49}," r)\n",[43,2272,2273],{"class":45,"line":632},[43,2274,1040],{"class":49},[12,2276,2277],{},"이렇게 사용한다.",[34,2279,2281],{"className":36,"code":2280,"language":38,"meta":39,"style":39},"paged(db.collection(\"galaxy\"), [{ $match: { answer: 42 } }], {\n  page,\n  pageSize,\n}).then(\n  lookup(db, {\n    from: \"hitchiker\",\n    localField: \"_id\",\n    foreignField: \"galaxy_id\",\n    as: \"hitchhikers\",\n  })\n);\n",[22,2282,2283,2306,2311,2316,2326,2334,2344,2354,2364,2374,2379],{"__ignoreMap":39},[43,2284,2285,2287,2290,2292,2294,2297,2300,2303],{"class":45,"line":46},[43,2286,753],{"class":69},[43,2288,2289],{"class":49},"(db.",[43,2291,1996],{"class":69},[43,2293,212],{"class":49},[43,2295,2296],{"class":363},"\"galaxy\"",[43,2298,2299],{"class":49},"), [{ $match: { answer: ",[43,2301,2302],{"class":123},"42",[43,2304,2305],{"class":49}," } }], {\n",[43,2307,2308],{"class":45,"line":76},[43,2309,2310],{"class":49},"  page,\n",[43,2312,2313],{"class":45,"line":105},[43,2314,2315],{"class":49},"  pageSize,\n",[43,2317,2318,2321,2323],{"class":45,"line":227},[43,2319,2320],{"class":49},"}).",[43,2322,1595],{"class":69},[43,2324,2325],{"class":49},"(\n",[43,2327,2328,2331],{"class":45,"line":242},[43,2329,2330],{"class":69},"  lookup",[43,2332,2333],{"class":49},"(db, {\n",[43,2335,2336,2339,2342],{"class":45,"line":255},[43,2337,2338],{"class":49},"    from: ",[43,2340,2341],{"class":363},"\"hitchiker\"",[43,2343,814],{"class":49},[43,2345,2346,2349,2352],{"class":45,"line":268},[43,2347,2348],{"class":49},"    localField: ",[43,2350,2351],{"class":363},"\"_id\"",[43,2353,814],{"class":49},[43,2355,2356,2359,2362],{"class":45,"line":296},[43,2357,2358],{"class":49},"    foreignField: ",[43,2360,2361],{"class":363},"\"galaxy_id\"",[43,2363,814],{"class":49},[43,2365,2366,2369,2372],{"class":45,"line":301},[43,2367,2368],{"class":49},"    as: ",[43,2370,2371],{"class":363},"\"hitchhikers\"",[43,2373,814],{"class":49},[43,2375,2376],{"class":45,"line":318},[43,2377,2378],{"class":49},"  })\n",[43,2380,2381],{"class":45,"line":330},[43,2382,2383],{"class":49},");\n",[12,2385,2386,2387,2389],{},"요즘은 대부분 그렇지 않지만 RDBMS의 ",[22,2388,912],{}," 만으로 문서의 페이징을 하는 경우에도 100만건 정도의 문서에서는 꽤 성능이 나오지 않았던 과거를 떠올려본다.",[12,2391,2392],{},"프로그램을 짜다 보면 데이터 설계 당시의 의도와는 다르게 복잡한 조회 조건이나 외래 키 없는 다른 데이터 컬렉션을 참조하고 싶다는 요구를 종종 받게 된다. 이때마다 인덱스나 외래키를 추가할 수는 없는 일이다. 결국 상황에 맞는 정교한 pipeline을 매번 잘 짜거나, 언어레벨의 서포트로 극뽁하는 수 밖에..",[12,2394,2395,2396,2398,2399,2401],{},"조금은 무책임한 ",[22,2397,894],{},"과 ",[22,2400,184],{},"의 퍼포먼스 문제로 약간은 당황했지만, mongodb만의 문제는 아닌 것으로.. 계속해서 발전하는 몽고디비가 되기를",[141,2403,2405],{"id":2404},"footnotes","Footnotes",[2407,2408,2409],"ol",{},[2410,2411,2412,2413],"li",{},"실제로 일반적인 경우엔 나쁘지 않은 성능으로 페이징 하는데 문제가 없다 ",[739,2414,2419],{"href":2415,"ariaLabel":2416,"className":2417,"dataFootnoteBackref":39},"#user-content-fnref-1","Back to reference 1",[2418],"data-footnote-backref","↩",[2421,2422,2423],"style",{},"html pre.shiki code .szrzo, html code.shiki .szrzo{--shiki-default:#ADBAC7}html pre.shiki code .s3aqa, html code.shiki .s3aqa{--shiki-default:#F47067}html pre.shiki code .slGcm, html code.shiki .slGcm{--shiki-default:#DCBDFB}html pre.shiki code .sSMXU, html code.shiki .sSMXU{--shiki-default:#6CB6FF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html pre.shiki code .skFXu, html code.shiki .skFXu{--shiki-default:#F69D50}html pre.shiki code .s6sc0, html code.shiki .s6sc0{--shiki-default:#96D0FF}html pre.shiki code .sca0q, html code.shiki .sca0q{--shiki-default:#768390}",{"title":39,"searchDepth":76,"depth":76,"links":2425},[2426,2427,2428,2429],{"id":143,"depth":76,"text":144},{"id":1126,"depth":76,"text":1127},{"id":1727,"depth":76,"text":1728},{"id":2404,"depth":76,"text":2405},null,"2020-06-20T00:00:00.000Z","몽고디비 aggregation을 페이징 할 때 성능 문제 해결기\\n","md",{"cover_image":2435},"/article/2020-06/20-mongo.jpg","/blog/2020-06/20-mongodb-performance-on-paging",{"title":7,"description":2438},"몽고디비 aggregation을 페이징 할 때 성능 문제 해결기\n","blog/2020-06/20-mongodb-performance-on-paging",[2441,2442,2443,193],"dev","mongodb","nodejs",["Reactive",2445],{},["Set"],["ShallowReactive",2448],{"$gA87qiXR3y":2430}]</script>
<script>window.__NUXT__={};window.__NUXT__.config={public:{content:{wsUrl:""},mdc:{components:{prose:true,map:{}},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}}}},app:{baseURL:"/",buildId:"81dd48f5-054f-4fcb-90d6-55c08acaf384",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body></html>